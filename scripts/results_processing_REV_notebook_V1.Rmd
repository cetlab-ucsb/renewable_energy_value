---
title: "Cost and Value Results"
output:
  html_document:
    df_print: paged
  pdf_document: default
---

<!--
This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 
Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
-->

Author: Ranjit Deshmukh 11/13/2016
This script does the following
1) Creates the results table using outputs from the results csv from the Renewable Energy Value model



```{r, echo=FALSE, warning=FALSE, include=FALSE}
library(gdata)
library(data.table)
library(lubridate)
library(ggplot2)
library(grid)
#library(reshape2)
#library(xlsx)
#library(Hmisc)
#library(gridExtra)
#library(xts)
library(stringr)
library(cowplot)
library(plyr)
#library(dplyr)
#library(rgdal) # for maps
#library(ggmap) # comes with a them_nothing() function
#library(Cairo) # creates high quality vector and bitmap images
#library(rgeos) # for maps
#library(maptools) # for maps
#library(bit64)
library(csvread)
library(scales)
library(knitr)
library(plotly)
library(gtable)
library(egg)
library(scales)
#library(regex)

```

```{r "knitr config", cache=FALSE, include=FALSE}
opts_knit$set(root.dir = "../")
getwd()
```


```{r, "setup", echo=FALSE}
## Set working directory ##
switch(Sys.info()[['sysname']],
       Windows= {"G:/Electricity_Models/renewable_energy_value/"},
       Linux  = {print("Linux!!!.")},
       #Darwin = {working.directory <- '/Volumes/RDExt1/Electricity_Models/renewable_energy_value/'})
       Darwin = {working.directory <- '/Users/ranjitster/Dropbox/renewable_energy_value/renewable_energy_value/'})

#setwd(working.directory)

knitr::opts_knit$set(root.dir = working.directory) # This code does not work!!! The root directory is still the one where the script is located. In a way, that is ok, because now the path to the inputs would be relative. 
getwd()
knitr::opts_chunk$set(echo=FALSE, comment=NA, warning=FALSE, message=FALSE, include=TRUE)
```

Define input files...

```{r, input file names, echo=FALSE}
input.folder <- "../india_REV_input/" # Remove the "../" if you want to knit the document. Issues with specifying working directory
output.folder <- "../india_REV_output/"
output.folder.processed.results <- "../processed_results/"
output.folder.paper <- "../processed_results/paper/"
#results.folder <- "processed_results_coalHC_coalLC_SolarLC20p/"
input.results.fname <- "results_all_scenarios.csv"
emissions.fname <- "emissions.csv"
gen.cost.fname <- "generator_cost_all.csv"
existing.gen.capacity.fname <- "existing_generation.csv"
scenario.inputs.fname <- "REvalue_input_csv.csv"
#scenario.inputs.fname <- "Scenarios_Cost_Master_v4.xlsx"
lc.solarPV.targets.weighted.cost.fname <- "LC_solarPV_targets_weighted_cost.csv"
lc.wind.targets.weighted.cost.fname <- "LC_wind_targets_weighted_cost.csv"

```

Specify scenarios to process...

```{r, scenarios, echo=FALSE}
scenarios <- c("base", "high_cost_coal", "coal_55mingen", "coal_ccgt_0mingen", "wind10LC", "wind20LC", "wind30LC", "solar10LC", "solar20LC", "solar30LC", "wind30LC_solar30LC", "wind30LC_solar30LC_coalHC", "wind120HH_solar1A", "battery15", "battery30", "battery60", "battery15B25LC", "battery30B25LC", "battery15B50LC", "battery30B50LC", "battery60B50LC", "battery60B50LC_wind30LC", "battery60B50LC_solar30LC", "battery60B50LC_wind30LC_solar30LC", "battery60_coalHC", "battery60B50LC_coalHC", "battery60B50LC_wind30LC_coalHC", "battery60B50LC_solar30LC_coalHC", "battery60B50LC_wind30LC_solar30LC_coalHC", "coal_55mingen_wind30LC", "coal_55mingen_solar30LC", "coal_55mingen_wind30LC_solar30LC", "load_modD0M0_energyOnly", "load_modD50M0_energyOnly", "load_modD25M25_energyOnly") 
```

User parameter inputs...

```{r, parameter inputs, echo=FALSE}
INR_USD <- 65
disc_rate <- 0.07 # CERC discount rate is 10.8%
plant_life <- 25 # in years
battery_life <- 20 # in years
plot.individual.scenario = "yes"
re_targets_to_plot = "200-400-600" # "200-300-400" OR "200-400-600"
use.weighted.costs.declining.cost.trajectory = "yes" # Set to yes if you want to use different costs for every future year based on a declining cost rate for RE. Then, need to use an input csv for weighted costs. COuld fold the exel calcs in R later. 
ann.cost.decl.rate.solarPV <- 0.05 # Annual rate of cost decline for low cost solar. Must match input csv
ann.cost.decl.rate.wind <- 0.03 # Annual rate of cost decline for low cost wind. Must match input csv
```

Function to grab legend...

```{r, grab legend, echo=FALSE}
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}
```

Import results and other parameter from csv files...

```{r, import csvs, echo=FALSE}
# Import the results and other parameters
results.input <- fread(paste0(output.folder, input.results.fname))
results.input <- results.input[order(rank)]
emissions <- fread(paste0(input.folder, emissions.fname))
gen.cost <- fread(paste0(input.folder, gen.cost.fname))
existing.gen.capacity <- fread(paste0(input.folder, existing.gen.capacity.fname))
scenario.inputs <- fread(paste0(input.folder, scenario.inputs.fname))
#scenario.inputs <- read.xlsx(paste0(input.folder, scenario.inputs.fname), sheetName = "REvalue_input_csv") # Eventually read worksheets directly from xslx
lc.solarPV.wt.costs <- fread(paste0(input.folder, lc.solarPV.targets.weighted.cost.fname))
lc.wind.wt.costs <- fread(paste0(input.folder, lc.wind.targets.weighted.cost.fname))
```


Creating empty results data tables and lists for plots...

```{r, create empty tables and lists for plots, echo=FALSE}
# Results processed data table
results.processed <- data.table()
results.costs.emissions.processed <- data.table()

## Lists for saving plots
p_vre <- list()
p_vre_curt <- list()
p_vre_storage_curt <- list()
p_vre_sys <- list()
p_value <- list()
p_vre_share <- list()
p_curt <- list()
p_avg_em <- list()
p_avg_em_bar <- list()
p_mar_em <- list()
p_em_combo <- list()
p_em_red_perc <- list()
p_em_tot <- list()
p_vre_share_uncurt <- list()
p_buildout <- list()
p_vre_sys_pLoad <- list()
p_vre_sys_perc <- list()
p_vre_sys_pLoad_perc <- list()

```

Capital recovery factor...

```{r, crf, echo=FALSE}
# Capital recovery factor (CRF)
crf <- (disc_rate*(1+disc_rate)^plant_life)/((1+disc_rate)^plant_life - 1)
crf.battery <- (disc_rate*(1+disc_rate)^battery_life)/((1+disc_rate)^battery_life - 1)
```


Preparing the results input table...
<!--Splitting the scenario and scenario_econ_dispatch names into 2.-->
<!--Replacing the No Re scenario builds S0W0 for battery storage scenarios with the base S0W0 scenario numbers. -->

```{r, prepping results table, echo=FALSE}
# Split the scenario column into 2. This should have been done in the python script
#results.input[, c("scenario", "scenario_econ_dispatch") := tstrsplit(scenario, "_", fixed=TRUE)]
results.input[, c("scenario", "scenario_econ_dispatch") := data.table(str_split_fixed(scenario, "_", n=2))]


# Results processed data table
results.processed <- data.table()
results.costs.emissions.processed <- data.table()

## Replace the S0W0 scenario rows for all battery scenarios with S0W0 base scenario ##
cols.to.replace <- colnames(results.input[,!c("scenario_main", "scenario_econ_dispatch")])
results.input[grepl("bat", scenario_main) & scenario == "S0W0",cols.to.replace] <- 
  results.input[grepl("base", scenario_main) & scenario == "S0W0",.SD, .SDcols = !c("scenario_main", "scenario_econ_dispatch")]
## Replace the S0W0 scenario rows for the high cost coal battery scenario with S0W0 high cost coal scenario ##
results.input[grepl("battery60_coalHC", scenario_main) & scenario == "S0W0",cols.to.replace] <- 
  results.input[grepl("high_cost_coal", scenario_main) & scenario == "S0W0",.SD, .SDcols = !c("scenario_main", "scenario_econ_dispatch")]

## Create a separate column for annual load. Whereas ann_gen_total_MWh is the annual load for most scenarios, the battery scenarios will have ann_gen_total_MWh greater than annual load by the amount equal to battery losses. So pull the annual load from the base scenario and provide that for the battery scenarios
results.input[, ann_load_total_MWh := ann_gen_total_MWh]
results.input[grepl("bat", scenario_main), ann_load_total_MWh := results.input[scenario_main == "base" & scenario == "S0W0", ann_load_total_MWh]]
```

### Variables description
VRE stands for variable renewable energy.

### Energy generation, capacity, and dispatch costs - inputs from REV model script
**dispatch_cost**: Total annual dispatch cost  
**ann_gen_total_MWh**: Annual total energy generation (includes losses due to battery storage)  
**ann_load_total_MWh**: Annual total load or demand (does not include losses due to battery storage)  
**ann_gen_vre_nocurt_MWh**: Uncurtailed VRE generation potential  
**ann_gen_vre_MWh**: Annual VRE energy generation  
**ann_curt_vre_MWh**: Annual curtailed VRE generation  
**ann_gen_solarPV_MWh**: Annual Solar PV energy generation  
**ann_gen_wind_MWh**: Annual Wind energy generation  
**ann_gen_coal_MWh**: Annual Coal energy generation  
**ann_gen_gas_ccgt_MWh**: Annual CCGT energy generation  
**ann_gen_gas_ct_MWh**: Annual CT energy generation  
**ann_gen_diesel_MWh**: Annual Diesel energy generation  
**ann_gen_hydro_MWh**: Annual Hydro (including storage hydro and RoR) energy generation  
**ann_gen_nuclear_MWh**: Annual Nuclear energy generation  
**ann_gen_other_MWh**: Annual 'Other' energy generation including biomass, bagasse.  
**ann_discharge_bat_storage_MWh**: Annual battery storage discharge  
**ann_charge_bat_storage_MWh**: Annual battery storage charge  
**new_capacity_coal_MW**: New coal capacity build  
**new_capacity_gas_ccgt_MW**: New ccgt capacity build  
**new_capacity_gas_ct_MW**: New ct capacity build  
**capacity_vre_MW**: VRE capacity  
**capacity_solarPV_MW**: Solar PV capacity  
**capacity_wind_MW**: Wind capacity  
**capacity_bat_storage_MW**: Battery storage capacity in MW  
**capacity_bat_storage_MWh**: Battery storage capacity in MWh (MWh/MW gives number of hours of battery storage)  

#### Total annual costs
**ann_cap_cost_coal_mil**: Annual capital cost of coal in millions
**ann_cap_cost_ccgt_mil**: Annual capital cost of CCGT in millions
**ann_cap_cost_ct_mil**: Annual capital cost of CT in millions
**ann_cap_cost_solar_mil**: Annual capital cost of solar PV in millions
**ann_cap_cost_wind_mil**: Annual capital cost of wind in millions
**ann_cap_cost_battery_mil**: Annual capital cost of battery storage in millions
**total_cost_new_conv**: Total annual cost of new conventional capacity (annualized cost)   
**total_cost_vre**: Total annual cost of VRE in million USD (annualized cost)   
**total_cost_capacity**: Total cost of conventional + VRE capacity i.e. total_cost_new_conv + total_cost_vre  
**total_cost_energy**: Total annual cost of energy generation from all generation sources (result from economic dispatch model)   
**total_cost**: Total annual cost i.e. total_cost_capacity + total_cost_energy (annualized fixed costs of existing conventional capacity is not included here. Cancels our for additional costs of VRE)   
**system_cost_vre**: Total annual additional cost of vre i.e. (total cost of VRE scenario - total cost of zero VRE scenario)   

#### Costs per curtailed or uncrutailed VRE
**cost_vre_pMWh**: Cost of VRE per MWh of VRE after curtailment i.e. (total_cost_vre/ann_gen_vre_MWh)   
**cost_vre_nocurt_pMWh**: Cost of VRE per MWh of VRE before curtailment i.e. (total_cost_vre/ann_gen_vre_nocurt_MWh)   
**cost_battery_pMWh**: Cost of battery storage per MWh of VRE after curtailment i.e. (ann_cap_cost_battery_mil*10^6/ann_gen_vre_MWh)   
**cost_battery_nocurt_pMWh**: Cost of battery storage per MWh of VRE before curtailment i.e. (ann_cap_cost_battery_mil*10^6/ann_gen_vre_nocurt_MWh)   
**cost_vre_battery_pMWh**: Cost of VRE and battery storage per MWh of VRE after curtailment i.e. (cost_vre_pMWh + cost_battery_pMWh) <-- USE THIS FOR EITHER VRE OR BOTH VRE AND BATTERY   
**cost_vre_battery_nocurt_pMWh**: Cost of VRE and battery storage per MWh of VRE before curtailment i.e. (cost_vre_nocurt_pMWh + cost_battery_nocurt_pMWh) <-- USE THIS FOR EITHER VRE OR BOTH VRE AND BATTERY   

#### Capacity and energy value
**capacity_value_pMWh**: Capacity value of VRE target per VRE generation after curtailment i.e. difference between annualized costs of new conventional capacity of VRE scenario and zero VRE scenario per MWh of VRE generation   
**energy_value_pMWh**: Energy value of VRE target per VRE generation after curtailment i.e. difference between total annual energy costs of VRE scenario and zero VRE scenario per MWh of VRE generation   
**total_value_pMWh**: Total of capacity and energy value of VRE i.e. (capacity_value_pMWh + energy_value_pMWh)   

#### Additional system cost due to VRE
**system_cost_vre_pMWh**: Additional system cost due to VRE for a VRE scenario compared to a zero VRE scenario  per MWH of VRE i.e. (cost_vre_pMWh + cost_battery_pMWh - capacity_value_pMWh - energy_value_pMWh)   
**system_cost_add_pMWh_load**: Additional system cost due to VRE for a VRE scenario compared to a zero VRE scenario  per MWH of Load served. (Load served now does not include battery storage losses in battery scenarios. Additional system cost is divided by ann_load_total_MWh.)   
**system_cost_add_perc**: Additional overall cost of VRE as a % of no VRE system cost   

#### Cost or benefit of mitigating CO2 emissions
**total_emissions_co2_milTonnes**: Total CO2 emissions in million tonnes   
**grid_emissions_factor_kg_kWh**: Grid emissions factor   
**cost_emissions_reduction_pTonneCO2_avg**: Average cost of CO2 reduction in USD per tonne of CO2   
**cost_emissions_reduction_pTonneCO2_marginal**: Marginal cost of CO2 reduction in USD per tonne of CO2 (for every 200 GW target)   


Processing results...

```{r, processing results, results='asis', echo=FALSE}
for (sc in 1:length(scenarios)){
  print(scenarios[sc])
  
  # Scenario names for scenario abbreviations and generator cost
  sc.gen.cost <- scenario.inputs[parameter == "generator_cost_suffix", get(scenarios[sc])]
  sc.econ.dispatch <- scenario.inputs[parameter == "economic_dispatch_folder_suffix", get(scenarios[sc])]
  sc.sensitivity <- scenario.inputs[parameter == "scenario_suffix", get(scenarios[sc])]
  sc.new.conv.capacity <- scenario.inputs[parameter == "new_conventional_capacity_folder_suffix", get(scenarios[sc])]
  
  # Choose data based on scenario
  results <- results.input[scenario_econ_dispatch == sc.econ.dispatch, ]
  results[,scenario_sensitivity := sc.sensitivity] # Specify the correct scenario name
  results[,scenario_main := scenarios[sc]] # Specify the correct main scenario name
  
  # Calculate installed capacity in GW and round off. This is used for merging different capital costs for different targets - declining costs of RE
  results[, capacity_solarPV_GW := round(capacity_solarPV_MW/1000, 0)]
  results[, capacity_wind_GW := round(capacity_wind_MW/1000, 0)]
  results[, capacity_bat_storage_GW := round(capacity_bat_storage_MW/1000, 0)]
  
  # Choose data based on scenario anc calculate annual 
  ann_fc_coal_cost <- gen.cost[technology=="coal" & cost_type == "capital", get(sc.gen.cost)] * crf + gen.cost[technology=="coal" & cost_type == "om", get(sc.gen.cost)]
  ann_fc_ccgt_cost <- gen.cost[technology=="ccgt" & cost_type == "capital", get(sc.gen.cost)] * crf + gen.cost[technology=="ccgt" & cost_type == "om", get(sc.gen.cost)]
  ann_fc_ct_cost <- gen.cost[technology=="ct" & cost_type == "capital", get(sc.gen.cost)] * crf + gen.cost[technology=="ct" & cost_type == "om", get(sc.gen.cost)]
  
  # Changed 4/21/2019. Creating separate columns for capital cost to facilitate different capital costs depending on targets
  # ann_fc_solar_cost <- gen.cost[technology=="solarPV" & cost_type == "capital", get(sc.gen.cost)] * crf + gen.cost[technology=="solarPV" & cost_type == "om", get(sc.gen.cost)]
  # ann_fc_wind_cost <- gen.cost[technology=="wind" & cost_type == "capital", get(sc.gen.cost)] * crf + gen.cost[technology=="wind" & cost_type == "om", get(sc.gen.cost)]
  # ann_fc_battery_cost <- gen.cost[technology=="battery" & cost_type == "capital", get(sc.gen.cost)] * crf.battery + gen.cost[technology=="battery" & cost_type == "om", get(sc.gen.cost)]
 
  results[, capital_solar_cost_USDpkW := gen.cost[technology=="solarPV" & cost_type == "capital", get(sc.gen.cost)]]
  results[, capital_wind_cost_USDpkW := gen.cost[technology=="wind" & cost_type == "capital", get(sc.gen.cost)]]
  results[, capital_battery_cost_USDpkW := gen.cost[technology=="battery" & cost_type == "capital", get(sc.gen.cost)]]
  
  # If we want to use a declining cost trajectory for wind and solar, then we use weighted average costs for each target based on an exogenous excel calculation that assumes existing capacity. 
  if (use.weighted.costs.declining.cost.trajectory == "yes"){
    # solar PV (only for solar30LC)
    if (grepl("solar30LC", scenarios[sc])){
      lc.solarPV.wt.costs.scenario <- lc.solarPV.wt.costs[, .SD, .SDcols = c("capacity_solarPV_GW", paste0("Weighted_cost_solarPV_USDpkW_", ann.cost.decl.rate.solarPV*100, "pc"))]
      setnames(lc.solarPV.wt.costs.scenario, paste0("Weighted_cost_solarPV_USDpkW_", ann.cost.decl.rate.solarPV*100, "pc"), "capital_solar_cost_USDpkW")
      results[, capital_solar_cost_USDpkW := NULL]
      results <- merge(results, lc.solarPV.wt.costs.scenario, by = "capacity_solarPV_GW", all = TRUE)
    }
    
    # wind (only for wind30LC)
    if (grepl("wind30LC", scenarios[sc])){
      lc.wind.wt.costs.scenario <- lc.wind.wt.costs[, .SD, .SDcols = c("capacity_wind_GW", paste0("Weighted_cost_wind_USDpkW_", ann.cost.decl.rate.wind*100, "pc"))]
      setnames(lc.wind.wt.costs.scenario, paste0("Weighted_cost_wind_USDpkW_", ann.cost.decl.rate.wind*100, "pc"), "capital_wind_cost_USDpkW")
      results[, capital_wind_cost_USDpkW := NULL]
      results <- merge(results, lc.wind.wt.costs.scenario, by = "capacity_wind_GW", all = TRUE)
    }
  }
  
  
  results[, ann_fc_solar_cost_USDpkWpy := capital_solar_cost_USDpkW * crf + gen.cost[technology=="solarPV" & cost_type == "om", get(sc.gen.cost)]]
  results[, ann_fc_wind_cost_USDpkWpy := capital_wind_cost_USDpkW * crf + gen.cost[technology=="wind" & cost_type == "om", get(sc.gen.cost)]]
  results[, ann_fc_battery_cost_USDpkWpy := capital_battery_cost_USDpkW * crf.battery + gen.cost[technology=="battery" & cost_type == "om", get(sc.gen.cost)]]
  
  #### Estimate total annual capacity costs
  results[,ann_cap_cost_coal_mil:= new_capacity_coal_MW * ann_fc_coal_cost/10^3]
  results[,ann_cap_cost_ccgt_mil:= new_capacity_gas_ccgt_MW * ann_fc_ccgt_cost/10^3]
  results[,ann_cap_cost_ct_mil:= new_capacity_gas_ct_MW * ann_fc_ct_cost/10^3]
  # results[,ann_cap_cost_solar_mil:= capacity_solarPV_MW * ann_fc_solar_cost/10^3]
  # results[,ann_cap_cost_wind_mil:= capacity_wind_MW * ann_fc_wind_cost/10^3]
  # results[,ann_cap_cost_battery_mil:= capacity_bat_storage_MW * ann_fc_battery_cost/10^3]
  
  results[,ann_cap_cost_solar_mil:= capacity_solarPV_MW * ann_fc_solar_cost_USDpkWpy/10^3]
  results[,ann_cap_cost_wind_mil:= capacity_wind_MW * ann_fc_wind_cost_USDpkWpy/10^3]
  results[,ann_cap_cost_battery_mil:= capacity_bat_storage_MW * ann_fc_battery_cost_USDpkWpy/10^3]

  results[,total_cost_new_conv:= ann_cap_cost_coal_mil + ann_cap_cost_ccgt_mil + ann_cap_cost_ct_mil]
  results[,total_cost_vre:= ann_cap_cost_solar_mil + ann_cap_cost_wind_mil]
  
  # Capacity, energy and total costs
  results[,total_cost_capacity:= total_cost_new_conv + total_cost_vre + ann_cap_cost_battery_mil] # Conventional gen + RE gens + battery
  results[,total_cost_energy:= dispatch_cost/INR_USD/10^6] # dispatch cost is in INR. Convert to USD.
  results[, total_cost:= total_cost_capacity + total_cost_energy]
  
  # Cost of No RE scenario
  total_cost_new_conv_noRE <- results[scenario=="S0W0", total_cost_capacity]
  total_cost_energy_noRE <- results[scenario=="S0W0", total_cost_energy]
  total_cost_noRE <- total_cost_new_conv_noRE + total_cost_energy_noRE
  
  # Alternate Cost of No RE scenario for battery scenarios (USE no RE costs from base scenario without any battery B0)
  # One option is in the results.inputs data table replace the S0W0 scenarios for B15 and B30 with B0 scenario results. That's the easiest. which is what I did - not manually but using code in the earlier section. No need to modify the CSV manually.
  
  
  # Total cost differences / increases between scenarios and No RE scenario
  results[scenario!="S0W0", system_cost_vre:= total_cost - total_cost_noRE]
  
  # Cost of VRE per MWh of absorbed VRE generation and uncurtailed/potential VRE generation
  results[,cost_vre_pMWh:= total_cost_vre*10^6/ann_gen_vre_MWh]
  results[,cost_vre_nocurt_pMWh:= total_cost_vre*10^6/ann_gen_vre_nocurt_MWh]
  
  # Cost of battery storage per MWh of absorbed VRE generation and uncurtailed/potential VRE generation
  results[,cost_battery_pMWh:= ann_cap_cost_battery_mil*10^6/ann_gen_vre_MWh]
  results[,cost_battery_nocurt_pMWh:= ann_cap_cost_battery_mil*10^6/ann_gen_vre_nocurt_MWh]
  
  # Cost of VRE and battery storage per MWh of absorbed VRE generation and uncurtailed/potential VRE generation
  results[,cost_vre_battery_pMWh:= (cost_vre_pMWh + cost_battery_pMWh)]
  results[,cost_vre_battery_nocurt_pMWh:= (cost_vre_nocurt_pMWh + cost_battery_nocurt_pMWh)]
  
  # Value per MWh of absorbed VRE generation
  results[scenario!="S0W0",capacity_value_pMWh:= (total_cost_new_conv_noRE - total_cost_new_conv)*10^6/ann_gen_vre_MWh]
  results[scenario!="S0W0",energy_value_pMWh:= (total_cost_energy_noRE - total_cost_energy)*10^6/ann_gen_vre_MWh]
  results[scenario!="S0W0",total_value_pMWh:= (capacity_value_pMWh + energy_value_pMWh)]
  results[scenario!="S0W0", system_cost_vre_pMWh:= cost_vre_pMWh + cost_battery_pMWh - capacity_value_pMWh - energy_value_pMWh]
  
  # Value per MWh of uncurtailed/potential VRE generation
  results[scenario!="S0W0",capacity_value_nocurt_pMWh:= (total_cost_new_conv_noRE - total_cost_new_conv)*10^6/ann_gen_vre_nocurt_MWh]
  results[scenario!="S0W0",energy_value_nocurt_pMWh:= (total_cost_energy_noRE - total_cost_energy)*10^6/ann_gen_vre_nocurt_MWh]
  results[scenario!="S0W0",total_value_nocurt_pMWh:= (capacity_value_nocurt_pMWh + energy_value_nocurt_pMWh)]
  results[scenario!="S0W0", system_cost_vre_nocurt_pMWh:= cost_vre_nocurt_pMWh + cost_battery_nocurt_pMWh - capacity_value_nocurt_pMWh - energy_value_nocurt_pMWh]
  
  # Additional cost of implementing VRE per MWh load served
  results[scenario!="S0W0", system_cost_add_pMWh_load:= (total_cost - total_cost_noRE)*10^6/ ann_load_total_MWh]
  
  # Additional overall cost % for implementing VRE compared to No RE
  results[scenario!="S0W0", system_cost_add_perc:= (total_cost - total_cost_noRE)/ total_cost_noRE]
  
  # VRE metrics #
  # VRE share
  results[scenario!="S0W0", vre_share_after_curt:= ann_gen_vre_MWh/ann_gen_total_MWh]
  results[scenario!="S0W0", vre_curt:= (ann_gen_vre_nocurt_MWh - ann_gen_vre_MWh)/ann_gen_vre_nocurt_MWh]
  results[scenario!="S0W0", vre_share_nocurt:= ann_gen_vre_nocurt_MWh/ann_gen_total_MWh]
  
  # Emissions #
  # Total emissions
  results[, total_emissions_co2_milTonnes:= (ann_gen_coal_MWh * emissions[technology=="coal", co2_tonnes_mwh] +
                                               ann_gen_gas_ccgt_MWh * emissions[technology=="ccgt", co2_tonnes_mwh] +
                                               ann_gen_gas_ct_MWh * emissions[technology=="ct", co2_tonnes_mwh] +
                                               ann_gen_diesel_MWh * emissions[technology=="diesel", co2_tonnes_mwh]) / 10^6]
  
  # Grid emissions factor kg/kWh
  results[, grid_emissions_factor_kg_kWh:= total_emissions_co2_milTonnes * 10^6 / ann_gen_total_MWh]
  
  # Emissions reduction in %
  total_emissions_co2_milTonnes_noRE <- results[scenario=="S0W0", total_emissions_co2_milTonnes]
  results[scenario!="S0W0", total_emissions_reduced_milTonnes:= (total_emissions_co2_milTonnes_noRE - total_emissions_co2_milTonnes)]
  results[scenario!="S0W0", emissions_reduction:= total_emissions_reduced_milTonnes/total_emissions_co2_milTonnes_noRE]
  
  # Average cost of emissions mitigation
  results[scenario!="S0W0", cost_emissions_reduction_pTonneCO2_avg:= system_cost_vre / total_emissions_reduced_milTonnes]
  
  # Marginal and average cost of emissions mitigation
  results.costs.emissions <- results[, .(scenario, scenario_main, scenario_sensitivity, scenario_build, scenario_split, total_cost, total_emissions_co2_milTonnes)]
  results.costs.emissions <- rbind(results.costs.emissions[rep(1, 4),], results.costs.emissions) # repeat the 0-0 row, so we can use difference by group
  results.costs.emissions[scenario=="S0W0", scenario_split:= unique(results.costs.emissions[scenario!="S0W0", scenario_split])]
  results.costs.emissions[, system_cost_inc_marginal:= c(NA, diff(total_cost)), by=scenario_split] # System cost increase
  results.costs.emissions[, system_emissions_dec_marginal:= c(NA, diff(total_emissions_co2_milTonnes))*-1, by=scenario_split] # emissions decrease from previous RE target
  results.costs.emissions[, cost_emissions_reduction_pTonneCO2_marginal:= system_cost_inc_marginal / system_emissions_dec_marginal] # Marginal emissions mitigation cost
  # Average cost of emissions mitigation again
  results.costs.emissions[scenario!="S0W0", system_cost_inc_total:= total_cost - total_cost_noRE] # System cost increase from S0W0
  results.costs.emissions[scenario!="S0W0", system_emissions_dec_total:= total_emissions_co2_milTonnes_noRE - total_emissions_co2_milTonnes] # emissions decrease from base S0W0
  results.costs.emissions[scenario!="S0W0", cost_emissions_reduction_pTonneCO2_average:= system_cost_inc_total / system_emissions_dec_total] # Average emissions mitigation cost
  
  
  ## Cost of wind and solar uncurtailed [ Note total VRE costs in the selected scenarios are equal to either total solar or total wind costs.] [12/2/2018 Note that this section is confusing. results.vre.costs doesn't seem to be used anywhere else. ]
  results.vre.costs <- results[scenario %in% c("S0W200", "S0W300", "S0W400", "S0W600"), .(scenario, total_cost_vre, ann_gen_vre_nocurt_MWh)]
  results.vre.costs[, technology:= "Wind"]
  results.vre.costs <- rbind(results.vre.costs, results[scenario %in% c("S200W0", "S300W0", "S400W0", "S600W0"), .(scenario, total_cost_vre, ann_gen_vre_nocurt_MWh)], fill=TRUE)
  results.vre.costs[is.na(technology), technology:= "Solar PV"]
  results.vre.costs[, Capacity:= c(200,300,400, 600, 200, 300, 400, 600)]
  
  ## Avoided conventional generation capacity
  results[, new_conventional_capacity_MW:= new_capacity_coal_MW + new_capacity_gas_ccgt_MW + new_capacity_gas_ct_MW]
  total_cap_new_conv_noRE <- results[scenario=="S0W0", new_conventional_capacity_MW]
  results[scenario!="S0W0", avoided_conv_cap_mw_perVREmw:= (total_cap_new_conv_noRE - (new_conventional_capacity_MW))/capacity_vre_MW]
  results[scenario!="S0W0", avoided_conv_cap_mw_per_new_conv_noRE_mw:= (total_cap_new_conv_noRE - (new_conventional_capacity_MW))/total_cap_new_conv_noRE]
  
  ## Share of coal in new conventional generation capacity
  results[, coal_share_new_conv_cap:= new_capacity_coal_MW/(new_capacity_coal_MW + new_capacity_gas_ccgt_MW + new_capacity_gas_ct_MW)]
  
  ## Plant load factors for conventional generation
  results[, existing_capacity_coal_MW := existing.gen.capacity[technology == 'coal', capacity_MW]]
  results[, existing_capacity_ccgt_MW := existing.gen.capacity[technology == 'gas_ccgt', capacity_MW]]
  results[, existing_capacity_ct_MW := existing.gen.capacity[technology == 'gas_ct', capacity_MW]]
  
  results[, plf_coal := (ann_gen_coal_MWh / ((new_capacity_coal_MW + existing_capacity_coal_MW)*8760))]
  results[, plf_gas := ((ann_gen_gas_ccgt_MWh + ann_gen_gas_ct_MWh) / ((new_capacity_gas_ccgt_MW + existing_capacity_ccgt_MW + new_capacity_gas_ct_MW + existing_capacity_ct_MW)*8760))]
  
  
  # Add results to results for all scenarios
  results.processed <- rbind(results.processed, results)
  results.costs.emissions.processed <- rbind(results.costs.emissions.processed, results.costs.emissions)
  
  head(results.processed)
  
  cat('\n')
}

  
```

Processed Results Table...
```{r}
print(head(results.processed))
```

write results csv...

```{r, echo=FALSE, eval=FALSE}
write.csv(results.processed, file = paste0(output.folder.processed.results, "results_processed_summary.csv"))
```

Scenarios for individual plots...

```{r, scenarios for individual plots, echo=FALSE}
scenarios <- c("base", "coal_55mingen", "wind10LC", "wind20LC", "wind30LC", "solar10LC", "solar20LC", "solar30LC", "wind30LC_solar30LC", "wind120HH_solar1A", "battery15", "battery30", "battery60","battery15B25LC", "battery30B25LC", "battery15B50LC", "battery30B50LC", "battery60B50LC", "high_cost_coal", "battery60_coalHC", "battery60B50LC_coalHC", "wind30LC_solar30LC_coalHC")

```

Pull scenario sensitivities...
```{r, scenario sensitivities, echo=FALSE}
scenarios.sensitivity <- ""
for (sc in 1:length(scenarios)){
  scenarios.sensitivity[[sc]] <- scenario.inputs[parameter == "scenario_suffix", get(scenarios[sc])]
}
```

Plot themes, positions, and labels. 
<!--Plus choose results based on RE targets e.g. 200, 300, 400 GW OR 200, 400, 600 GW, based on user input-->
Processing `r re_targets_to_plot` GW scenarios...
```{r, plot themes, echo=FALSE}
theme_set(theme_cowplot(font_size=9))
colors_RD3 <- c("#fd8d3c", "#2b8cbe", "#969696")
colors_RD5 <- c("#2b8cbe", "#fd8d3c", "#969696")
colors_RD7 <- c("#5588bb", "#66bbbb", "#aa6644", "#99bb55","#ee9944", "#444466", "#bb5555")
colors_RD8 <- c("#5588bb", "#aa6644", "#99bb55","#ee9944", "#66bbbb", "#444466", "#bb5555")
colors_emissions_RD4 <- c("#d95f0e", "#999999", "#ca0020", "#a6611a", "#3a3938" )
colors_solar_wind_split <- c("#252525", "#3182bd", "#9ecae1", "#66c2a4", "#fec44f", "#d95f0e")

width.bar = 0.7

positions2 <- c("0-100", "25-75", "50-50", "75-25", "100-0")
positions4 <- c("0-0", "0-100", "25-75", "50-50", "75-25", "100-0")
positions.tech <- c("New Coal", "New Gas CCGT", "New Gas CT", "Battery Storage", "Solar PV", "Wind", "Existing Coal", "Existing Gas CCGT", "Existing Gas CT", "Existing Diesel", "Existing Hydro Storage", "Existing Hydro RoR", "Existing Nuclear", "Existing Other")
positions.tech.new <- c("New Coal", "New Gas CCGT", "New Gas CT", "Battery Storage", "Solar PV", "Wind", "Existing Coal", "Existing Gas CCGT", "Existing Gas CT", "Existing Diesel", "Existing Hydro Storage", "Existing Hydro RoR", "Existing Nuclear", "Existing Other")
#Labels
share.labels <- c("S 0% - W 100%", "S 25% - W 75%", "S 50% - W 50%", "S 75% - W 25%", "S 100% - W 0%", "S 0% - W 100%", "S 25% - W 75%", "S 50% - W 50%", "S 75% - W 25%", "S 100% - W 0%", "S 0% - W 100%", "S 25% - W 75%", "S 50% - W 50%", "S 75% - W 25%", "S 100% - W 0%")

# Select data, labels, and y axis limits to plot based on RE targets
if (re_targets_to_plot == "200-300-400"){
  
  results.processed = results.processed[scenario_build != "600 GW", ] 
  positions <- c("S0W200", "S50W150", "S100W100", "S150W50", "S200W0", "S0W300", "S75W225", "S150W150", "S225W75", "S300W0", "S0W400", "S100W300", "S200W200", "S300W100", "S400W0")
  positions3 <- c("S0W0", "S0W200", "S50W150", "S100W100", "S150W50", "S200W0", "S0W300", "S75W225", "S150W150", "S225W75", "S300W0", "S0W400", "S100W300", "S200W200", "S300W100", "S400W0")
  share.labels2 <- c("S 0 - W 0", "S 0 - W 200", "S 50 - W 150", "S 100 - W 100", "S 150 - W 50", "S 200 - W 0", "S 0 - W 300", "S 75 - W 225", "S 150 - W 150", "S 225 - W 75", "S 300 - W 0", "S 0 - W 400", "S 100 - W 300", "S 200 - W 200", "S 300 - W 100", "S 400 - W 0")
  target.labels <- c("0", "200", "300", "400")
  target.labels2 <- c("0 GW", "200 GW", "300 GW", "400 GW")
  
  y_limits_vre_share <- c(0, 0.5)
  y_limits_vre_cost <- c(0, 100)
  y_limits_capacity_value <- c(0, 100)
  y_limits_energy_value <- c(0, 100)
  y_limits_sys_cost <- c(-5, 15)
  y_limits_sys_cost_perc <- c(-0.2, 0.6)
  y_limits_cost_emissions <- c(-50, 100)

} else if (re_targets_to_plot == "200-400-600"){
  
  results.processed = results.processed[scenario_build != "300 GW", ] 
  positions <- c("S0W200", "S50W150", "S100W100", "S150W50", "S200W0", "S0W400", "S100W300", "S200W200", "S300W100", "S400W0", "S0W600", "S150W450", "S300W300", "S450W150", "S600W0")
  positions3 <- c("S0W0", "S0W200", "S50W150", "S100W100", "S150W50", "S200W0", "S0W400", "S100W300", "S200W200", "S300W100", "S400W0", "S0W600", "S150W450", "S300W300", "S450W150", "S600W0")
  share.labels2 <- c("S 0 - W 0", "S 0 - W 200", "S 50 - W 150", "S 100 - W 100", "S 150 - W 50", "S 200 - W 0", "S 0 - W 400", "S 100 - W 300", "S 200 - W 200", "S 300 - W 100", "S 400 - W 0", "S 0 - W 600", "S 150 - W 450", "S 300 - W 300", "S 450 - W 150", "S 600 - W 0")
  target.labels <- c("0", "200", "400", "600")
  target.labels2 <- c("0 GW", "200 GW", "400 GW", "600 GW")
  
  y_limits_vre_share <- c(0, 0.6)
  y_limits_vre_cost <- c(0, 150)
  y_limits_capacity_value <- c(0, 150)
  y_limits_energy_value <- c(0, 150)
  y_limits_sys_cost <- c(-6, 25)
  y_limits_sys_cost_perc <- c(-0.2, 0.6)
  y_limits_cost_emissions <- c(-25, 150)
}

```

Create individual plots [Disabled with eval = FALSE]...

```{r, individual plots, eval=FALSE, echo=FALSE, results='asis'}
for (sc in 1:length(scenarios)){
  print(sc)
  
  ## VRE cost per MWh - both before and after curtailment
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, cost_vre_pMWh, cost_vre_nocurt_pMWh)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  data.plot <- melt(data.plot, id.vars = c("scenario", "scenario_build"))
  data.plot[variable=="cost_vre_nocurt_pMWh", variable:= "No Curtailment"][variable=="cost_vre_pMWh", variable:= "After Curtailment"]
  
  # data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario)) # Use if sorting screws up
  
  p_vre[[sc]] <- ggplot(data.plot, aes(scenario, value, fill = variable)) +
    geom_bar(stat = "identity", width = width.bar, position="dodge") +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Average Levelized Cost of VRE Generation \n USD/MWh", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="top", legend.title = element_blank(), legend.text = element_text(size = 18)) +
    scale_y_continuous(limits = c(0, 100), sec.axis = sec_axis(~.*INR_USD/1000, name = "INR/kWh")) +
    background_grid()

  ## VRE cost per MWh - Only after curtailment
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, cost_vre_pMWh)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  data.plot <- melt(data.plot, id.vars = c("scenario", "scenario_build"))
  data.plot[variable=="cost_vre_pMWh", variable:= "Cost of RE"]
  
  # data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario)) # Use if sorting screws up
  
  p_vre_curt[[sc]] <- ggplot(data.plot, aes(scenario, value, fill = variable)) +
    geom_bar(stat = "identity", width = width.bar, position="dodge") +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Average Levelized Cost of VRE Generation \n USD/MWh (after curtailment)", x = NULL) +
    scale_fill_manual(values = colors_RD5) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="top", legend.title = element_blank(), legend.text = element_text(size = 18)) +
    scale_y_continuous(limits = c(0, 100), sec.axis = sec_axis(~.*INR_USD/1000, name = "INR/kWh")) +
    background_grid()
  
  ## VRE + Battery Storage cost per MWh of VRE - Only after curtailment ####
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, cost_battery_pMWh, cost_vre_pMWh)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  data.plot <- melt(data.plot, id.vars = c("scenario", "scenario_build"))
  data.plot[variable=="cost_vre_pMWh", variable:= "Cost of RE"][variable=="cost_battery_pMWh", variable:= "Cost of Battery Storage"]
  data.plot$variable <- reorder.factor(data.plot$variable, new.order = c("Cost of Battery Storage", "Cost of RE"))
  
  # data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario)) # Use if sorting screws up
  
  p_vre_storage_curt[[sc]] <- ggplot(data.plot[order(data.plot$variable)], aes(scenario, value, fill = variable)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Average Cost of VRE and Storage \n USD/MWh (VRE after curtailment)", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="top", legend.title = element_blank(), legend.text = element_text(size = 18)) +
    scale_y_continuous(limits = c(0, 100), sec.axis = sec_axis(~.*INR_USD/1000, name = "INR/kWh of VRE (after curtailment)")) +
    background_grid()

  
  ## System cost for VRE implementation per MWh VRE absorbed
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, rank, system_cost_vre_pMWh)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  # data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario)) # Use if sorting screws up
  
  p_vre_sys[[sc]] <- ggplot(data.plot, aes(scenario, system_cost_vre_pMWh, fill = scenario_build)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Average Additional Cost of VRE Implementation \nUSD/MWh of VRE (after curtailment)", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position = "none") +
    scale_y_continuous(limits = c(-20, 80), sec.axis = sec_axis(~.*INR_USD/1000, name = "INR/kWh of VRE (after curtailment)")) +
    background_grid()
  
  ## System cost for VRE implementation per MWh Load served
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, rank, system_cost_add_pMWh_load)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  # data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario)) # Use if sorting screws up
  
  p_vre_sys_pLoad[[sc]] <- ggplot(data.plot, aes(scenario, system_cost_add_pMWh_load, fill = scenario_build)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Average Additional Cost of VRE Implementation \nUSD/MWh of Load", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) + 
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position = "none") +
    scale_y_continuous(limits = c(-5, 15), sec.axis = sec_axis(~.*INR_USD/1000, name = "INR/kWh of Load")) +
    background_grid()
  
  ## System cost for VRE implementation in percentage
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, rank, system_cost_add_perc)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  # data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario)) # Use if sorting screws up
  
  p_vre_sys_perc[[sc]] <- ggplot(data.plot, aes(scenario, system_cost_add_perc, fill = scenario_build)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Additional System Cost of VRE", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) + 
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position = "none") +
    scale_y_continuous(limits = c(-0.2, 0.5), labels = percent) +
    background_grid()

  ## System cost for VRE implementation per MWh Load served and in percentage [Note that this plot cannot be used in multiple scenarios when the multiplier can be different for different scenarios. ]
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, rank, system_cost_add_pMWh_load)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  # data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario)) # Use if sorting screws up
  # multiplier for y axis
  y_multiplier_sys_cost_to_perc <- results.processed[scenario == "S0W200" & scenario_main == scenarios[sc], system_cost_add_perc]/results.processed[scenario == "S0W200" & scenario_main == scenarios[sc], system_cost_add_pMWh_load]
  
  p_vre_sys_pLoad_perc[[sc]] <- ggplot(data.plot, aes(scenario, system_cost_add_pMWh_load, fill = scenario_build)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Additional System Cost of VRE \nUSD/MWh of Load", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) + 
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position = "none") +
    scale_y_continuous(limits = c(-5, 15), sec.axis = sec_axis(~.*y_multiplier_sys_cost_to_perc, labels = percent)) +
    background_grid()
  
  ##Energy and capacity value per MWh
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, energy_value_pMWh, capacity_value_pMWh)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  data.plot <- melt(data.plot, id.vars = c("scenario", "scenario_build"))
  data.plot[variable=="capacity_value_pMWh", variable:= "Capacity Value"][variable=="energy_value_pMWh", variable:= "Energy Value"]
  
  p_value[[sc]] <- ggplot(data.plot, aes(scenario, value, fill = variable)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Average Value of VRE \nUSD/MWh of VRE (after curtailment)", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="top", legend.title = element_blank(), legend.text = element_text(size = 18)) +
    scale_y_continuous(limits = c(0, 100), sec.axis = sec_axis(~.*INR_USD/1000, name = "INR/kWh of VRE (after curtailment)")) +
    background_grid()
  
  
  ## VRE share
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, vre_share_nocurt, vre_share_after_curt)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  data.plot <- melt(data.plot, id.vars = c("scenario", "scenario_build"))
  data.plot[variable=="vre_share_nocurt", variable:= "No Curtailment"][variable=="vre_share_after_curt", variable:= "With Curtailment"]
  
  p_vre_share[[sc]] <- ggplot(data.plot, aes(scenario, value, fill = variable)) +
    geom_bar(stat = "identity", width = width.bar, position="dodge") +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "VRE share of total electricity generation", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="top", legend.title = element_blank()) +
    scale_y_continuous(limits = c(0, 0.5), labels=percent) +
    background_grid()
  
  # VRE potential share - only uncurtailed
  data.plot <- data.plot[variable=="No Curtailment",]
  p_vre_share_uncurt[[sc]] <- ggplot(data.plot, aes(scenario, value, fill = variable)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Potential VRE share of total electricity generation", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="none", legend.title = element_blank()) +
    scale_y_continuous(limits = c(0, 0.5), labels=percent) +
    background_grid()
  
  
  ## VRE curtailment
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, rank, vre_curt)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  
  p_curt[[sc]] <- ggplot(data.plot, aes(scenario, vre_curt, fill = scenario_build)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = "Annual VRE curtailment", x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position = "none") +
    scale_y_continuous(limits = c(0, 0.6), labels=percent) +
    background_grid()
  

  ## EMISSIONS
  # % of emissions reduced
  data.plot <- results.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, emissions_reduction, total_emissions_co2_milTonnes)]
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  p_em_red_perc[[sc]] <- ggplot(data.plot, aes(scenario, emissions_reduction, fill = scenario_build)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = expression(CO[2]~Emissions~Reduction~from~No~RE~Scenario), x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="none") +
    scale_y_continuous(limits = c(0, 0.5), labels=percent) +
    background_grid()
  
  # Total emissions 
  p_em_tot[[sc]] <- ggplot(data.plot, aes(scenario, total_emissions_co2_milTonnes, fill = scenario_build)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = expression(Total~CO[2]~Emissions~(million~tonnes)), x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="none") +
    background_grid()
  
  ## CO2 emissions cost of mitigation
  # Average cost of emissions
  data.plot <- results.costs.emissions.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, scenario_split, cost_emissions_reduction_pTonneCO2_marginal, cost_emissions_reduction_pTonneCO2_average)]
  data.plot$scenario_split <- reorder.factor(data.plot$scenario_split, new.order=positions2)
  # data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario)) # Use if sorting screws up
  
  p_avg_em[[sc]] <- ggplot(data.plot, aes(scenario_build, cost_emissions_reduction_pTonneCO2_average , group=scenario_split, color = scenario_split, linetype = scenario_split)) +
    geom_line(size=1) +
    labs(y = expression(Average~Cost~of~CO[2]~Emissions~Mitigation~(USD/tonne~CO[2])), x = NULL) +
    scale_fill_manual(values = colors_RD7) + 
    theme(axis.text.x = element_text(angle=0, vjust=1), legend.position = "bottom", legend.title = element_blank()) +
    scale_y_continuous(limits = c(-20, 100)) +
    background_grid()
  
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  
  p_avg_em_bar[[sc]] <- ggplot(data.plot, aes(scenario, cost_emissions_reduction_pTonneCO2_average, fill = scenario_build)) +
    geom_bar(stat = "identity", width = width.bar) +
    facet_wrap(~scenario_build, scales = "free_x") + 
    labs(y = expression(Average~Cost~of~CO[2]~Emissions~Mitigation~(USD/tonne~CO[2])), x = NULL) +
    scale_fill_manual(values = colors_RD3) + 
    scale_x_discrete(breaks=positions, labels=share.labels) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.position="none") +
    scale_y_continuous(limits = c(-20, 100)) +
    background_grid()
  
  
  # Marginal cost of emissions
  data.plot <- results.costs.emissions.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, scenario_split, cost_emissions_reduction_pTonneCO2_marginal, cost_emissions_reduction_pTonneCO2_average)]
  data.plot$scenario_split <- reorder.factor(data.plot$scenario_split, new.order=positions2)
  #data.plot_sorted <- as.data.table(data.plot %>% arrange(scenario_split)) # Use if sorting screws up
  
  p_mar_em[[sc]] <- ggplot(data.plot, aes(scenario_build, cost_emissions_reduction_pTonneCO2_marginal , group=scenario_split, color = scenario_split, linetype = scenario_split)) +
    geom_line(size=1) +
    labs(y = expression(Marginal~Cost~of~CO[2]~Emissions~Mitigation~(USD/tonne~CO[2])), x = NULL) +
    scale_fill_manual(values = colors_RD7) + 
    theme(axis.text.x = element_text(angle=0, vjust=1), legend.position = "bottom", legend.title = element_blank()) +
    scale_y_continuous(limits = c(-100, 600)) +
    background_grid()
  
  
  ## Average and marginal emissions cost 
  data.plot <- results.costs.emissions.processed[scenario!="S0W0" & scenario_main == scenarios[sc], .(scenario, scenario_build, scenario_split, cost_emissions_reduction_pTonneCO2_marginal, cost_emissions_reduction_pTonneCO2_average)]
  data.plot$scenario_split <- reorder.factor(data.plot$scenario_split, new.order=positions2)
  data.plot <- melt(data.plot, id.vars = c("scenario", "scenario_build", "scenario_split"))
  data.plot[variable=="cost_emissions_reduction_pTonneCO2_marginal", variable:= "Marginal Cost"][variable=="cost_emissions_reduction_pTonneCO2_average", variable:= "Average Cost"]
  
  p_em_combo[[sc]] <- ggplot(data.plot, aes(scenario_build, value , group=interaction(scenario_split, variable), color = scenario_split, linetype = variable)) +
    geom_line(size=1) +
    labs(y = expression(Cost~of~CO[2]~Emissions~Mitigation~(USD/tonne~CO[2])), x = NULL) +
    scale_fill_manual(values = colors_RD7) + 
    theme(axis.text.x = element_text(angle=0, vjust=1), legend.position = "bottom", legend.title = element_blank()) +
    scale_y_continuous(limits = c(-20, 600)) +
    background_grid()
  
  ## Capacity buildout stack #########
  capacity.buildout <- results.processed[scenario_main == scenarios[sc], .(scenario, scenario_build, new_capacity_coal_MW, new_capacity_gas_ccgt_MW, new_capacity_gas_ct_MW, capacity_solarPV_MW, capacity_wind_MW)]
  setnames(capacity.buildout, c("new_capacity_coal_MW", "new_capacity_gas_ccgt_MW", "new_capacity_gas_ct_MW", "capacity_solarPV_MW", "capacity_wind_MW"), c("New Coal", "New Gas CCGT", "New Gas CT", "Solar PV", "Wind"))
  capacity.buildout.melt <- melt(capacity.buildout, id.vars = c("scenario", "scenario_build"))
  setnames(capacity.buildout.melt, c("variable", "value"), c("technology", "capacity_MW"))
  
  # Existing capacity
  scenario_list <- capacity.buildout[, .(scenario, scenario_build)]
  existing.gen.capacity.all.scenarios <- cbind(existing.gen.capacity[rep(seq(nrow(existing.gen.capacity)), 16)], scenario_list[rep(seq_len(nrow(scenario_list)), each=9),])
  
  # join the new and existing buildouts
  capacity.all <- rbind(capacity.buildout.melt, existing.gen.capacity.all.scenarios)
  capacity.all[, capacity_GW:= capacity_MW/10^3]
  capacity.all[technology=="coal", technology:= "Existing Coal"]
  capacity.all[technology=="gas_ccgt", technology:= "Existing Gas CCGT"]
  capacity.all[technology=="gas_ct", technology:= "Existing Gas CT"]
  capacity.all[technology=="diesel", technology:= "Existing Diesel"]
  capacity.all[technology=="hydro_storage", technology:= "Existing Hydro Storage"]
  capacity.all[technology=="hydro_pondage", technology:= "Existing Hydro RoR"]
  capacity.all[technology=="hydro_ror", technology:= "Existing Hydro RoR"]
  capacity.all[technology=="nuclear", technology:= "Existing Nuclear"]
  capacity.all[technology=="other", technology:= "Existing Other"]
  
  # Plot the buildout
  capacity.all$technology <- reorder.factor(capacity.all$technology, new.order=positions.tech)
  capacity.all$scenario <- reorder.factor(capacity.all$scenario, new.order=positions3)
  capacity.all <- capacity.all[order(-technology)]
  
  colors.capacity.buildout <- c("#CC79A7", "#D55E00", "#56B4E9", "#0072B2", "#000000", "#CC3333", "#FF6600", "#999999", "#FF9900", "#006699", "#CC3333", "#FF6600", "#999999")
  colors.capacity.buildout <- c("#666666", "#FF6600", "#CC3333", "#FF9900", "#006699", "#999999", "#FF6600", "#CC3333", "#000000", "#0072B2", "#56B4E9", "#D55E00", "#CC79A7")
                                
  p_buildout[[sc]] <- ggplot(capacity.all, aes(scenario, capacity_GW, fill = technology, order = technology)) +
    geom_bar(stat = "identity", width = width.bar) +
    labs(y = "Installed Capacity (MW)", x = NULL) +
    scale_fill_manual(values = colors.capacity.buildout) + 
    scale_x_discrete(breaks=positions3, labels=share.labels2) +
    theme(axis.text.x = element_text(angle=60, hjust=1, vjust=1), legend.title = element_blank()) +
    background_grid()
  
}

```

Print and save the plots [Disabled with eval=FALSE]...
```{r, print and save plots, echo=FALSE, eval=FALSE}
if(plot.individual.scenario == "yes"){
  for(sc in 1:length(scenarios)){
  
    # Get the scenario suffix corresponding to the scenario name
    sc.sensitivity <- scenario.inputs[parameter == "scenario_suffix", get(scenarios[sc])]
    
    results.folder <- paste0("processed_results/processed_results_", scenarios[sc], "-", scenarios.sensitivity[sc], "/")
    ifelse(!dir.exists(file.path(results.folder)), dir.create(file.path(results.folder), recursive=TRUE), FALSE)
    
    
    file_suffix <- paste0(scenarios.sensitivity[sc])
    
    ## Levelized cost of VRE before and after curtailment
    ggsave(file = paste0(results.folder, "vre_levelized-cost-", file_suffix, ".png"), p_vre[[sc]])
    
    ## Levelized cost of VRE after curtailment
    ggsave(file = paste0(results.folder, "vre_curt-levelized-cost-", file_suffix, ".png"), p_vre_curt[[sc]])
    
    ## Levelized cost of VRE and storage per MWh VRE absorbed
    ggsave(file = paste0(results.folder, "vre_curt-storage-levelized-cost-", file_suffix, ".png"), p_vre_storage_curt[[sc]])
    
    ## System cost of VRE per MWh VRE absorbed
    ggsave(file = paste0(results.folder, "vre_integration-cost-", file_suffix, ".png"), p_vre_sys[[sc]])
    
    ## System cost of VRE per MWh load served
    ggsave(file = paste0(results.folder, "vre_integration-cost-per-load-", file_suffix, ".png"), p_vre_sys_pLoad[[sc]])
    
    ## Value of VRE
    ggsave(file = paste0(results.folder, "vre_value-", file_suffix, ".png"), p_value[[sc]])
    
    ## VRE share not curtailed
    ggsave(file = paste0(results.folder, "vre_share-uncurt-", file_suffix, ".png"), p_vre_share_uncurt[[sc]])
    
    ## VRE share - both curtailed and not curtailed
    ggsave(file = paste0(results.folder, "vre_share-curt-uncurt-", file_suffix, ".png"), p_vre_share[[sc]])
    
    ## VRE curtailment
    ggsave(file = paste0(results.folder, "vre_curtailment-", file_suffix, ".png"), p_curt[[sc]])
    
    ## Emissions 
    ggsave(file = paste0(results.folder, "emissions-mar-", file_suffix, ".png"), p_mar_em[[sc]])
    
    ggsave(file = paste0(results.folder, "emissions-avg-", file_suffix, ".png"), p_avg_em[[sc]])
    
    ggsave(file = paste0(results.folder, "emissions-avg-bar-", file_suffix, ".png"), p_avg_em_bar[[sc]])
    
    ## Emissions average and marginal combined in one
    plot.legend <- g_legend(p_em_combo[[1]])
    ggsave(file = paste0(results.folder, "emissions-avg-mar-", file_suffix, ".png"), p_em_combo[[sc]])
    
    ## Emissions average and marginal combined but separate plots
    plot.legend <- g_legend(p_avg_em[[sc]])
    combo.plot <- arrangeGrob(arrangeGrob(p_avg_em[[sc]] + theme(legend.position="none") + ggtitle("A") ,
                                          p_mar_em[[sc]] + theme(legend.position="none") + ggtitle("B"),nrow=1),
                              plot.legend, nrow=2,heights=c(10,1))
    ggsave(file = paste0(results.folder, "emissions-avg-mar-separate-", file_suffix, ".png"), combo.plot)
    
    
    ## Emissions reduction in %
    ggsave(file = paste0(results.folder, "emissions-reduction-perc-", file_suffix, ".png"), p_em_red_perc[[sc]])
    
    ## Emissions total
    ggsave(file = paste0(results.folder, "emissions-total-", file_suffix, ".png"), p_em_tot[[sc]])
    
    ## Capacity buildout
    ggsave(file = paste0(results.folder, "capacity-buildout", file_suffix, ".png"), p_buildout[[sc]])
    
  }
}

```


###Plot functions  
1) Line plots with facets by VRE target  
2) Line plots with facets by VRE target + points for minimum values
3) Line plots with facets by VRE target + points for minimum values
4) Line plots with facets by VRE split

```{r, plot functions, echo=FALSE}

# Plot function for facet lines plot by VRE target
plot.facet.allLines <- function(results.input, main_variable, scenarios.to.include, scenarios.labels, positions, plot.colors, plot.linetype, plot_title, y_limits, y_label, y_label_sec, y_sec_multiplier){
  
  # Process data to plot
  data.plot <- results.input[scenario!="S0W0" & scenario_main %in% scenarios.to.include, .(scenario_main, scenario, scenario_build, get(main_variable))]
  setnames(data.plot, c("V4"), c(eval(main_variable)))
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)

  q <- ggplot(data.plot, aes(scenario, get(main_variable), group = scenario_main, color = scenario_main, linetype = scenario_main)) +
    geom_hline(color = "grey", yintercept = 0) +
    geom_line(size=0.5) +
    #theme_bw() +
    facet_wrap(~scenario_build, scales = "free_x") +
    labs(y = y_label, x = NULL) +
    scale_color_manual(labels = scenarios.labels, values = plot.colors) + 
    scale_linetype_manual(labels = scenarios.labels, values = plot.linetype) +
    scale_x_discrete(breaks=positions, labels=share.labels) +
    ggtitle(plot_title) +
    theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.position="bottom", legend.title = element_blank(), 
          legend.key = element_rect(size=5, fill = "white"), legend.key.size = unit(0.5, 'lines'), legend.key.width = unit(1, 'lines'), 
          plot.title = element_text(face="plain"), 
          strip.background = element_rect(colour="black")) +
    scale_y_continuous(limits = y_limits, sec.axis = sec_axis(~.*y_sec_multiplier, name = y_label_sec)) +
    background_grid()
  
  return(q)
}

# Plot function for facet lines plot by VRE target + points for minimum values
plot.facet.allLines.min <- function(results.input, main_variable, scenarios.to.include, scenarios.labels, positions, plot.colors, plot.linetype, plot_title, y_limits, y_label, y_label_sec, y_sec_multiplier){
  
  # Process data to plot
  data.plot <- results.input[scenario!="S0W0" & scenario_main %in% scenarios.to.include, .(scenario_main, scenario, scenario_build, get(main_variable))]
  setnames(data.plot, c("V4"), c(eval(main_variable)))
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  
  data.plot.min <- data.plot[, .SD[which.min(get(main_variable))], by = c("scenario_main", "scenario_build")]

  q <- ggplot(data.plot, aes(scenario, get(main_variable), group = scenario_main, color = scenario_main, linetype = scenario_main)) +
    geom_hline(color = "grey", yintercept = 0) +
    geom_line(size=0.5) +
    geom_point(data = data.plot.min, mapping = aes(x = scenario, y = get(main_variable), group = scenario_main, color = scenario_main)) +
    #theme_bw() +
    facet_wrap(~scenario_build, scales = "free_x") +
    labs(y = y_label, x = NULL) +
    scale_color_manual(labels = scenarios.labels, values = plot.colors) + 
    scale_linetype_manual(labels = scenarios.labels, values = plot.linetype) +
    scale_x_discrete(breaks=positions, labels=share.labels) +
    ggtitle(plot_title) +
    theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.position="bottom", legend.title = element_blank(), 
          legend.key = element_rect(size=5, fill = "white"), legend.key.size = unit(0.5, 'lines'), legend.key.width = unit(1, 'lines'), 
          plot.title = element_text(face="plain"), 
          strip.background = element_rect(colour="black")) +
    scale_y_continuous(limits = y_limits, sec.axis = sec_axis(~.*y_sec_multiplier, name = y_label_sec)) +
    background_grid()
  
  return(q)
}

# Plot function for facet lines plot by VRE target + points for maximum values
plot.facet.allLines.max <- function(results.input, main_variable, scenarios.to.include, scenarios.labels, positions, plot.colors, plot.linetype, plot_title, y_limits, y_label, y_label_sec, y_sec_multiplier){
  
  # Process data to plot
  data.plot <- results.input[scenario!="S0W0" & scenario_main %in% scenarios.to.include, .(scenario_main, scenario, scenario_build, get(main_variable))]
  setnames(data.plot, c("V4"), c(eval(main_variable)))
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  
  data.plot.max <- data.plot[, .SD[which.max(get(main_variable))], by = c("scenario_main", "scenario_build")]

  q <- ggplot(data.plot, aes(scenario, get(main_variable), group = scenario_main, color = scenario_main, linetype = scenario_main)) +
    geom_hline(color = "grey", yintercept = 0) +
    geom_line(size=0.5) +
    geom_point(data = data.plot.max, mapping = aes(x = scenario, y = get(main_variable), group = scenario_main, color = scenario_main)) +
    #theme_bw() +
    facet_wrap(~scenario_build, scales = "free_x") +
    labs(y = y_label, x = NULL) +
    scale_color_manual(labels = scenarios.labels, values = plot.colors) + 
    scale_linetype_manual(labels = scenarios.labels, values = plot.linetype) +
    scale_x_discrete(breaks=positions, labels=share.labels) +
    ggtitle(plot_title) +
    theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.position="bottom", legend.title = element_blank(), 
          legend.key = element_rect(size=5, fill = "white"), legend.key.size = unit(0.5, 'lines'), legend.key.width = unit(1, 'lines'), 
          plot.title = element_text(face="plain"), 
          strip.background = element_rect(colour="black")) +
    scale_y_continuous(limits = y_limits, sec.axis = sec_axis(~.*y_sec_multiplier, name = y_label_sec)) +
    background_grid()
  
  return(q)
}

# Plot function for facet lines plot by VRE split
plot.allLines.byVREsplit <- function(results.input, main_variable, scenarios.to.include, scenarios.labels, positions, plot.colors, plot.linetype, plot_title, y_limits, y_label, y_label_sec, y_sec_multiplier){
  
  # Process data to plot
  data.plot <- results.input[scenario!="S0W0" & scenario_main %in% scenarios.to.include, .(scenario_main, scenario, scenario_build, scenario_split, get(main_variable))]
  setnames(data.plot, c("V5"), c(eval(main_variable)))
  data.plot$scenario_split <- reorder.factor(data.plot$scenario_split, new.order=positions2)
  
  q <- ggplot(data.plot, aes(scenario_build, get(main_variable), group = interaction(scenario_split, scenario_main), color = scenario_main,
                             linetype = scenario_split)) +
    geom_line(size=0.5) +
    #theme_bw() +
    labs(y = y_label, x = NULL) +
    scale_color_manual(labels = scenarios.labels.vre, values = plot.colors) + 
    scale_linetype_manual(labels = share.labels, values = plot.linetype) +
    #scale_x_discrete(breaks=positions, labels=share.labels) +
    ggtitle(plot_title) +
    theme(axis.text.x = element_text(angle=0, hjust=0.5, vjust=1), legend.position="bottom", legend.title = element_blank(), 
          legend.key = element_rect(size=5, fill = "white"), legend.key.size = unit(0.5, 'lines'), legend.key.width = unit(1, 'lines'), 
          plot.title = element_text(face="plain"),
          strip.background = element_rect(color="black")) +
    scale_y_continuous(limits = y_limits, sec.axis = sec_axis(~.*y_sec_multiplier, name = y_label_sec)) +
    background_grid()
  
  return(q)
}


```

### RE share, RE curtailment, Coal PLFs, and grid emissions factors
```{r, vre share & curt - coal plfs - emissions factors, echo=FALSE}


scenarios.to.include.multivar <- c("base", "wind30LC_solar30LC_coalHC", 
                              "coal_55mingen",
                              "battery30", "battery60",
                              "load_modD25M25_energyOnly", "load_modD50M0_energyOnly")
scenarios.labels.multivar <- c("Base case", "Coal cost\nhigh",
                          "Min gen level\ncoal fleet 55%",
                          "Battery storage \n30 GW 4 h", "Battery storage \n60 GW 4 h",
                          "Demand profile\nIndia 50%-\nDL & MUM 25%", 
                          "Demand profile\nIndia 50%-\nDL 50%")



point_shapes_multivar <- c(16, 3, 1, 0, 2, 4)
colors_solar_wind_split <- c("#969696", "#0868ac", "#9ecae1", "#31a354", "#fec44f", "#d95f0e")


plot.facet.points <- function(results.input, main_variable, scenarios.to.include, scenarios.labels, positions, plot.colors, plot_shapes, plot_title, y_limits, y_label){
  
  # Process data to plot
  data.plot <- results.input[scenario_main %in% scenarios.to.include, .(scenario_main, scenario, scenario_build, scenario_split, get(main_variable))]
  setnames(data.plot, c("V5"), c(eval(main_variable)))
  set(data.plot,which(is.na(data.plot[[eval(main_variable)]])),eval(main_variable),0) # Convert NAs to zeros for No Re scenarios
  #data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions3)
  data.plot$scenario_split <- reorder.factor(data.plot$scenario_split, new.order=positions4)
  # Replace scenario main with labels
  data.plot$scenario_main <- mapvalues(data.plot$scenario_main, scenarios.to.include, scenarios.labels)
  data.plot$scenario_main <- reorder.factor(data.plot$scenario_main, new.order=scenarios.labels)
  
  q = ggplot(data.plot, aes(scenario_build, get(main_variable), group = scenario_split, color = scenario_split)) +
    geom_point(size=1) +
    theme_bw() +
    facet_wrap(~scenario_main, strip.position = "top", nrow = 1) +
    labs(y = y_label, x = "Variable Renewable Energy (VRE) target (GW)") +
    scale_color_manual(values = plot.colors, name = "Solar % - Wind %") +
    #scale_shape_manual(values=point_shapes_multivar, name = "Solar % - Wind %") +
    expand_limits(y=0) +
    scale_x_discrete(expand=c(0,1), labels = target.labels) +
    theme(text = element_text(size=8), axis.ticks.x = element_blank(),
          axis.text.y = element_text(size=7), axis.title.y = element_text(size=7),
          strip.text=element_text(angle=0),
          strip.background = element_rect(color="black", fill="white"), strip.placement = "outside",
          panel.grid.minor = element_blank())
  return(q)
}

  
p_vre_share_mult_scenarios <- plot.facet.points(results.processed, "vre_share_after_curt", scenarios.to.include.multivar, scenarios.labels.multivar, positions3, colors_solar_wind_split, point_shapes_multivar, "VRE share of total electricity generation", y_limits_vre_share, "VRE \nshare")
  
p_vre_curt_mult_scenarios <- plot.facet.points(results.processed, "vre_curt", scenarios.to.include.multivar, scenarios.labels.multivar, positions3, colors_solar_wind_split, point_shapes_multivar, "VRE curtailment", y_limits_vre_share, "VRE \ncurtailment")

p_avoided_conv_cap_mult_scenarios <- plot.facet.points(results.processed, "avoided_conv_cap_mw_perVREmw", scenarios.to.include.multivar, scenarios.labels.multivar, positions3, colors_solar_wind_split, point_shapes_multivar, "Conventional\ncapacity avoided\nper VRE MW", y_limits_vre_share, "Conventional\ncapacity avoided\n(MW per VRE MW)")

p_coal_plf_mult_scenarios <- plot.facet.points(results.processed, "plf_coal", scenarios.to.include.multivar, scenarios.labels.multivar, positions3, colors_solar_wind_split, point_shapes_multivar, "Coal fleet plant load factors", y_limits_vre_share, "Coal fleet\nplant load factors")

p_emissions_factor_mult_scenarios <- plot.facet.points(results.processed, "grid_emissions_factor_kg_kWh", scenarios.to.include.multivar, scenarios.labels.multivar, positions3, colors_solar_wind_split, point_shapes_multivar, "Grid emissions factor", y_limits_vre_share, "Emissions \n factor \n (kg CO2/kWh)")


g_vre_share_mult_scenarios <- ggplotGrob(p_vre_share_mult_scenarios + 
                                           scale_y_continuous(labels = percent, limits = c(0,1)) + 
                                           theme(legend.position = "none", axis.text.x = element_blank(), axis.title.x = element_blank()))

g_vre_curt_mult_scenarios <- ggplotGrob(p_vre_curt_mult_scenarios + 
                                          scale_y_continuous(labels = percent, limits = c(NA,1)) + 
                                           theme(legend.position = "none", axis.text.x = element_blank(), axis.title.x = element_blank(),
                                                 strip.background = element_blank(), strip.text = element_blank()))

g_avoided_conv_cap_mult_scenarios <- ggplotGrob(p_avoided_conv_cap_mult_scenarios + 
                                          scale_y_continuous(limits = c(0,1)) + 
                                           theme(legend.position = "none", axis.text.x = element_blank(), axis.title.x = element_blank(),
                                                 strip.background = element_blank(), strip.text = element_blank()))

g_coal_plf_mult_scenarios <- ggplotGrob(p_coal_plf_mult_scenarios + 
                                          scale_y_continuous(labels = percent, limits = c(0,1)) + 
                                           theme(legend.position = "none", axis.text.x = element_blank(), axis.title.x = element_blank(),
                                                 strip.background = element_blank(), strip.text = element_blank()))

g_emissions_factor_mult_scenarios <- ggplotGrob(p_emissions_factor_mult_scenarios + scale_y_continuous(limits = c(0,1)) +
                                           theme(legend.position = "none", 
                                                 axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1, size = 7),
                                                 strip.background = element_blank(), strip.text = element_blank()))


plot.legend <- g_legend(p_vre_share_mult_scenarios + theme(legend.position = "right"))


grob_multivar.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_mult_scenarios, g_vre_curt_mult_scenarios, g_avoided_conv_cap_mult_scenarios, g_coal_plf_mult_scenarios,
                           g_emissions_factor_mult_scenarios, size = "last")), ncol = 1)

grob_multivar.plot <-
  arrangeGrob(arrangeGrob(grobs =
                list(rbind(g_vre_share_mult_scenarios, g_vre_curt_mult_scenarios, g_avoided_conv_cap_mult_scenarios, g_coal_plf_mult_scenarios,
                           g_emissions_factor_mult_scenarios, size = "last")), ncol = 1), plot.legend, ncol=2, widths=c(10,2))

grid.newpage()
grid.draw(grob_multivar.plot)

#ggsave(file = paste0(output.folder.paper, "share_curt_plf_emissions", "_v0", ".png"), grob_multivar.plot, width=7, height=6)
#ggsave(file = paste0(output.folder.paper, "share_curt_plf_emissions", "_v0", ".pdf"), grob_multivar.plot, width=8, height=6.5)




```


### Solar and wind share split
```{r, solar wind share plot, echo=FALSE, message=FALSE}

colors.vre <- c("#FF9900", "#006699")

data.plot <- results.processed[scenario!="S0W0" & scenario_main == "base", .(scenario_main, scenario, scenario_build, scenario_split)]
data.plot[, c("solar", "wind") := data.table(str_split_fixed(scenario_split, "-", n=2))]
data.plot <- melt(data.plot, id.vars = c("scenario_main", "scenario", "scenario_build", "scenario_split"), variable.name = "technology", value.name = "share")
data.plot[, share_perc := as.numeric(share)/100]
data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)

p_vre_split <- ggplot(data.plot, aes(scenario, share_perc, group = technology, fill = technology)) +
  geom_bar(stat = "identity", width = width.bar) +
  #theme_bw() +
  facet_wrap(~scenario_build, scales = "free_x") +
  labs(y = "VRE share", x = NULL) +
  scale_fill_manual(values = colors.vre) + 
  scale_x_discrete(breaks = positions, labels=share.labels) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.title = element_blank(), legend.position = "bottom", legend.justification = "center") + 
  scale_y_continuous(labels = percent, sec.axis = sec_axis(trans = ~.*1, name = "", breaks = derive(), labels = derive())) +
  guides(fill = guide_legend(reverse = TRUE)) # reverses the order of the legend
```


### Wind, solar and coal cost inividual plots (absorbed/curtailed and uncurtailed/potential VRE generation)
```{r, vre coal plots, echo=FALSE, message = FALSE}

scenarios.to.include.vre <- c("base", "wind30LC", "solar30LC", "wind30LC_solar30LC", "wind30LC_solar30LC_coalHC")
scenarios.labels.vre <- c("base cost wind, solar & coal", "low cost solar", "low cost wind", "low cost wind & solar", "low cost wind & solar + high cost coal")
linetype_vre <- c(rep("solid", 6)) #c("solid", rep("dashed", 3), "solid", "solid")

#scenarios.to.include.vre <- c("base")
#scenarios.labels.vre <- c("base case")


## Share of VRE
p_vre_share <- plot.facet.allLines.max(results.processed, "vre_share_after_curt", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "VRE share of total electricity generation", y_limits_vre_share, "", "")
# Add vre share without curtailment as a black line
data.plot.to.add <- results.processed[scenario!="S0W0" & scenario_main == "base", .(scenario_main, scenario, scenario_build, vre_share_nocurt)]
#setnames(data.plot, c("V4"), c(eval(main_variable)))
data.plot.to.add$scenario <- reorder.factor(data.plot.to.add$scenario, new.order=positions)

p_vre_share_w_noCurt <- p_vre_share + geom_line(data = data.plot.to.add, aes(scenario, vre_share_nocurt, group = scenario_main), color = "black", size=0.5) +
facet_wrap(~scenario_build, scales = "free_x") +
scale_y_continuous(limits = y_limits_vre_share, labels = scales::percent_format(accuracy = 2), 
                   sec.axis = sec_axis(~.*1, name = "")) +
  theme(axis.text.y.right = element_blank())
p_vre_share_w_noCurt


# VRE share with no curtailment only [Used only for grobbing legend]
data.plot.to.add[, scenario_main := "potential VRE share of generation"]
p_vre_share_noCurt <- ggplot(data.plot.to.add, aes(scenario, vre_share_nocurt, group = scenario_main)) +
  geom_line(aes(color = scenario_main)) +
  facet_wrap(~scenario_build, scales = "free_x") +
  scale_color_manual(values = c("black")) +
  scale_y_continuous(limits = y_limits_vre_share, labels = scales::percent_format(accuracy = 2)) +
  theme(legend.position = "right", legend.title = element_blank())
#p_vre_share_noCurt
  

## Cost of VRE
p_vre <- plot.facet.allLines.min(results.processed, "cost_vre_battery_pMWh", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "Average Cost of VRE", y_limits_vre_cost, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_vre + scale_linetype_manual(labels = scenarios.labels.vre, values = c("solid", rep("dashed", 3), "solid"))

## Cost of VRE uncurtailed
p_vre_noCurt <- plot.facet.allLines.min(results.processed, "cost_vre_battery_nocurt_pMWh", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "Average Cost of Potential VRE", y_limits_vre_cost, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_vre_noCurt + scale_linetype_manual(labels = scenarios.labels.vre, values = c("solid", rep("dashed", 3), "solid"))

## Capacity value of VRE
p_capacity_value <- plot.facet.allLines.max(results.processed, "capacity_value_pMWh", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "Average Capacity Value of VRE", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_capacity_value

## Capacity value of VRE uncurtailed
p_capacity_value_noCurt <- plot.facet.allLines.max(results.processed, "capacity_value_nocurt_pMWh", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "Average Capacity Value of Potential VRE", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_capacity_value_noCurt

## Energy value of VRE
p_energy_value <- plot.facet.allLines.max(results.processed, "energy_value_pMWh", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "Average Energy Value of VRE", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_energy_value

## Energy value of VRE uncurtailed
p_energy_value_noCurt <- plot.facet.allLines.max(results.processed, "energy_value_nocurt_pMWh", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "Average Energy Value of Potential VRE", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_energy_value_noCurt

## System additional cost of VRE
p_sys_cost <- plot.facet.allLines.min(results.processed, "system_cost_add_pMWh_load", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "Average Additional Cost of VRE", y_limits_sys_cost, "USD/MWh of Load", "INR/kWh of Load\n", INR_USD/1000)
p_sys_cost

## System additional cost of VRE in percentage
p_sys_cost_perc <- plot.facet.allLines.min(results.processed, "system_cost_add_perc", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, "Additional System Cost of VRE", y_limits_sys_cost_perc, "", "", INR_USD/1000)
p_sys_cost_perc <- p_sys_cost_perc + scale_y_continuous(limits = y_limits_sys_cost_perc, labels = scales::percent_format(accuracy = 2), sec.axis = sec_axis(~.*1, name = " ")) +
  theme(axis.text.y.right = element_blank())
p_sys_cost_perc

## Cost of CO2 emissions mitigation
p_cost_emissions_avg <- plot.facet.allLines.min(results.processed, "cost_emissions_reduction_pTonneCO2_avg", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD7, linetype_vre, expression(Cost~of~CO[2]~Emissions~Mitigation), y_limits_cost_emissions, expression(USD/tonne~CO[2]), expression(INR/kg~CO[2]), INR_USD/1000)
p_cost_emissions_avg

## expression to use: expression(atop("INR/kg"~"CO"[2], paste("\n")))

```

### Wind solar and coal plots in a panel (cost and value expressed as per uncurtailed VRE)
#### Key Insights

Uncurtailed VRE shares range from 17-20% for 200 GW, 30-38% for 400 GW, and 41-50% for 600 GW VRE targets.  

However, after curtailment due to technical and economic reasons, VRE shares drop to 11-20% for 200 GW, 12-35% for 400 GW, and 13-43% for 600 GW VRE targets. 

VRE curtailment is greatest for solar dominated scenarios. Because of the constraint on minimum generation levels (70% in the base scenario), coal plants are unable to back down in order to accommodate solar generation in spit of its zero marginal cost. In this study, coal plants are assumed to stay online throughout the day if their generation is essential to meet net peak demand at any time of the day. 

High cost coal, when costs for air pollution control systems are included, decreases average additional cost of VRE to the system to below zero for 3 out of the 5 VRE split scenarios with a 600 GW target because VRE displaces coal generation with a higher variable cost.   

```{r, uncurtailed vre panel, eval = TRUE, echo=TRUE, message = TRUE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 
## Uses outputs from previous chunk
## VRE cost and value is expressed as per MWh of uncurtailed VRE

p_vre_share_w_noCurt1 <- p_vre_share_w_noCurt + theme(legend.position = "none", axis.text.x = element_blank())
g_vre_share_w_noCurt <- ggplotGrob(p_vre_share_w_noCurt1)

g_vre_noCurt <- ggplotGrob(p_vre_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))
g_vre_noCurt2 <- ggplotGrob(p_vre_noCurt + theme(legend.position = "none"))

## Modify the legend looks in this plot. 
g_capacity_value_noCurt <- ggplotGrob(p_capacity_value_noCurt + theme(legend.position = c(0, 0.65), axis.text.x = element_blank())) 
g_capacity_value_noCurt2 <- ggplotGrob(p_capacity_value_noCurt + theme(legend.position = "none", axis.text.x = element_blank())) 

g_energy_value_noCurt <- ggplotGrob(p_energy_value_noCurt + theme(legend.position = "none"))

g_sys_cost <- ggplotGrob(p_sys_cost + theme(legend.position = "none", axis.text.x = element_blank()))
g_sys_cost2 <- ggplotGrob(p_sys_cost + theme(legend.position = "none"))

g_sys_cost_perc <- ggplotGrob(p_sys_cost_perc + theme(legend.position = "none", 
                                                      axis.title.y.right = element_text(size=42), , axis.text.x = element_blank()))

g_cost_emissions_avg <- ggplotGrob(p_cost_emissions_avg + theme(legend.position = "none"))

#### This panel is with real additional system costs of VRE
grob_vre_noCurt.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_w_noCurt, g_capacity_value_noCurt, g_energy_value_noCurt, size = "last"), 
                     rbind(g_vre_noCurt, g_sys_cost, g_cost_emissions_avg, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_vre_noCurt.plot)

#### This panel is with % additional system costs due to VRE.
grob_vre_noCurt_sys_cost_perc.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_w_noCurt, g_capacity_value_noCurt, g_energy_value_noCurt, size = "last"), 
                     rbind(g_vre_noCurt, g_sys_cost_perc, g_cost_emissions_avg, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_vre_noCurt_sys_cost_perc.plot)

#### This panel is with only 5 plots, legend is outside of plot, and CO2 emissions are omitted. 
# Grob the two legends - scenarios and black line for vre no curtailment
plot.legend.vre.cost <- g_legend(p_capacity_value_noCurt + theme(legend.position = "right", legend.margin = margin(l=2, unit='cm')))

plot.legend.vre.nocurt <- g_legend(p_vre_share_noCurt + theme(legend.position = "right", legend.margin = margin(l=2, unit='cm')))

# First column plot
grob_vre_noCurt.5plot.1 <-
  arrangeGrob(grobs =
                list(rbind(g_vre_share_w_noCurt, g_capacity_value_noCurt2, g_energy_value_noCurt, size = "last")), ncol = 1)

# Second column plot
grob_vre_noCurt.5plot.2 <-
  arrangeGrob(grobs =
                list(rbind(g_vre_noCurt, g_sys_cost2, size = "last")), ncol = 1)

grob_plot_legend_vre_cost_nocurt <- plot_grid(plot.legend.vre.nocurt, plot.legend.vre.cost, nrow = 2, rel_heights = c(1,4))

grob_vre_noCurt.5plot.2.legend <- plot_grid(grob_plot_legend_vre_cost_nocurt, grob_vre_noCurt.5plot.2,
                                  nrow = 2,
                                rel_heights = c(1,2.6))

grob_vre_noCurt.5plot.3 <- plot_grid(grob_vre_noCurt.5plot.1, grob_vre_noCurt.5plot.2.legend,
                                            ncol = 2,
                                            rel_widths = c(1,1.02))

grob_vre_noCurt.5plot.3



## This panel is with % additional system costs due to VRE. New way, this aligns the vre split with the rest of the plots
# gA=ggplot_gtable(ggplot_build(p_vre_share_w_noCurt1))
# gB=ggplot_gtable(ggplot_build(p_vre1))
# gC=ggplot_gtable(ggplot_build(p_capacity_value1))
# gD=ggplot_gtable(ggplot_build(p_energy_value1))
# gE=ggplot_gtable(ggplot_build(p_sys_cost_perc1))
# gF=ggplot_gtable(ggplot_build(p_cost_emissions_avg1))
# 
# maxWidth = grid::unit.pmax(gA$widths, gB$widths, gC$widths, gD$widths, gE$widths, gF$widths)
# gA$widths <- as.list(maxWidth)
# gB$widths <- as.list(maxWidth)
# gC$widths <- as.list(maxWidth)
# gD$widths <- as.list(maxWidth)
# gE$widths <- as.list(maxWidth)
# gF$widths <- as.list(maxWidth)
# 
# maxHeight = grid::unit.pmax(gA$heights, gB$heights, gC$heights, gD$heights, gE$heights, gF$heights)
# gA$heights <- as.list(maxHeight)
# gB$heights <- as.list(maxHeight)
# gC$heights <- as.list(maxHeight)
# gD$heights <- as.list(maxHeight)
# gE$heights <- as.list(maxHeight)
# gF$heights <- as.list(maxHeight)
# 
# grob_vre_sys_cost_perc.plot <- arrangeGrob(gA,gB,gC,gD,gE,gF,nrow=3)
# 
# grid.newpage()
# grid.draw(grob_vre_sys_cost_perc.plot)


# ggsave(file = paste0(output.folder.paper, "wind_solar_coal_costs_vre_nocurt_all_var", "_v1", ".png"), grob_vre_noCurt.plot, width=7, height=5)
# ggsave(file = paste0(output.folder.paper, "wind_solar_coal_costs_vre_noCurt_all_var_sys_cost_perc", "_v1", ".png"), grob_vre_noCurt_sys_cost_perc.plot, width=7, height=5)
# ggsave(file = paste0(output.folder.paper, "wind_solar_coal_costs_vre_noCurt_5_var", "_v1", ".png"), grob_vre_noCurt.5plot.3, width=7, height=5)
```

### Wind solar and coal plots in a panel (cost and value expressed as per curtailed VRE)

```{r, vre panel, eval = TRUE, echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 
## Uses outputs from previous chunk

g_vre_share_w_noCurt <- ggplotGrob(p_vre_share_w_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_vre <- ggplotGrob(p_vre + theme(legend.position = "none", axis.text.x = element_blank()))

## Modify the legend looks in this plot. 
g_capacity_value <- ggplotGrob(p_capacity_value + theme(legend.position = c(0, 0.65), axis.text.x = element_blank())) 

g_energy_value <- ggplotGrob(p_energy_value + theme(legend.position = "none", axis.text.x = element_blank()))

g_sys_cost <- ggplotGrob(p_sys_cost + theme(legend.position = "none"))

g_cost_emissions_avg <- ggplotGrob(p_cost_emissions_avg + theme(legend.position = "none"))

grob_vre_curt.plot <-
  arrangeGrob(grobs =
                list(rbind(g_vre_share_w_noCurt, g_capacity_value, g_sys_cost, size = "last"),
                     rbind(g_vre, g_energy_value, g_cost_emissions_avg, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_vre_curt.plot)

#ggsave(file = paste0(output.folder.paper, "wind_solar_coal_costs_vre_curt_all_var", "_v0", ".png"), grob_vre_curt.plot, width=7, height=5)

```

### Battery storage plots

```{r, battery storage, echo=FALSE, message = FALSE}

scenarios.to.include.battery <- c("base", "battery30", "battery60", "battery60B50LC", "battery60B50LC_coalHC")
scenarios.labels.battery <- c("base case - no battery", "battery 30 GW 4h", "battery 60 GW 4h", "battery 60 GW 4h low cost", "battery 60 GW 4h low cost + high cost coal")
linetype_battery <- c(rep("solid", 5)) #c("solid", rep("dashed", 2), "solid", "solid")

## Share of VRE
p_vre_share_w_storage <- plot.facet.allLines.max(results.processed, "vre_share_after_curt", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery,  "VRE share of total electricity generation", y_limits_vre_share, "", "", INR_USD/1000)
# Add vre share without curtailment as a black line
data.plot.to.add <- results.processed[scenario!="S0W0" & scenario_main == "base", .(scenario_main, scenario, scenario_build, vre_share_nocurt)]
#setnames(data.plot, c("V4"), c(eval(main_variable)))
data.plot.to.add$scenario <- reorder.factor(data.plot.to.add$scenario, new.order=positions)

p_vre_share_w_storage_w_noCurt <- p_vre_share_w_storage + geom_line(data = data.plot.to.add, aes(scenario, vre_share_nocurt, group = scenario_main), color = "black", size=0.5) +
facet_wrap(~scenario_build, scales = "free_x") +
scale_y_continuous(limits = y_limits_vre_share, labels = scales::percent_format(accuracy = 2),
                                      sec.axis = sec_axis(~.*1, name = "")) +
  theme(axis.text.y.right = element_blank())
p_vre_share_w_storage_w_noCurt

## Cost of VRE and storage
p_vre_storage <- plot.facet.allLines.min(results.processed, "cost_vre_battery_pMWh", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery,  "Average Cost of VRE and Storage", y_limits_vre_cost, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_vre_storage

## Cost of VRE uncurtailed and storage
p_vre_storage_noCurt <- plot.facet.allLines.min(results.processed, "cost_vre_battery_nocurt_pMWh", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery, "Average Cost of Potential VRE and Storage", y_limits_vre_cost, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_vre_storage_noCurt

## Capacity value of VRE
p_capacity_value_w_storage <- plot.facet.allLines.max(results.processed, "capacity_value_pMWh", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery, "Average Capacity Value of VRE and Storage", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_capacity_value_w_storage

## Capacity value of VRE uncurtailed
p_capacity_value_w_storage_noCurt <- plot.facet.allLines.max(results.processed, "capacity_value_nocurt_pMWh", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery, "Average Capacity Value of Potential VRE and Storage", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_capacity_value_w_storage_noCurt

## Energy value of VRE
p_energy_value_w_storage <- plot.facet.allLines.max(results.processed, "energy_value_pMWh", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery, "Average Energy Value of VRE and Storage", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_energy_value_w_storage

## Energy value of VRE uncurtailed
p_energy_value_w_storage_noCurt <- plot.facet.allLines.max(results.processed, "energy_value_nocurt_pMWh", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery, "Average Energy Value of Potential VRE and Storage", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_energy_value_w_storage_noCurt

## System additional cost of VRE
p_sys_cost_w_storage <- plot.facet.allLines.min(results.processed, "system_cost_add_pMWh_load", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery, "Average Additional Cost of VRE and storage", y_limits_sys_cost, "USD/MWh of Load", "INR/kWh of Load\n", INR_USD/1000)
p_sys_cost_w_storage

## System additional cost of VRE in percentage
p_sys_cost_w_storage_perc <- plot.facet.allLines.min(results.processed, "system_cost_add_perc", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery, "Additional System Cost of VRE and storage", y_limits_sys_cost_perc, "", "", INR_USD/1000)
p_sys_cost_w_storage_perc <- p_sys_cost_w_storage_perc + scale_y_continuous(limits = y_limits_sys_cost_perc, labels = scales::percent_format(accuracy = 2), sec.axis = sec_axis(~.*1, name = "")) +
  theme(axis.text.y.right = element_blank())
p_sys_cost_w_storage_perc

## Cost of CO2 emissions mitigation
p_cost_emissions_avg_w_storage <- plot.facet.allLines.min(results.processed, "cost_emissions_reduction_pTonneCO2_avg", scenarios.to.include.battery, scenarios.labels.battery, positions, colors_RD8, linetype_battery, expression(Cost~of~CO[2]~Emissions~Mitigation), y_limits_cost_emissions, expression(USD/tonne~CO[2]), expression(INR/kg~CO[2]), INR_USD/1000)
p_cost_emissions_avg_w_storage

```

### Battery storage plots in a panel (cost and value expressed as per uncurtailed VRE)
Modify the battery plots in this code chunk. 

```{r, battery storage panel (per uncurtailed VRE), echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 

g_vre_share_w_storage_w_noCurt <- ggplotGrob(p_vre_share_w_storage_w_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_vre_storage_noCurt <- ggplotGrob(p_vre_storage_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))
g_vre_storage_noCurt2 <- ggplotGrob(p_vre_storage_noCurt + theme(legend.position = "none"))

g_capacity_value_w_storage_noCurt <- ggplotGrob(p_capacity_value_w_storage_noCurt + theme(legend.position = c(0, 0.65), axis.text.x = element_blank()))
g_capacity_value_w_storage_noCurt2 <- ggplotGrob(p_capacity_value_w_storage_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_energy_value_w_storage_noCurt <- ggplotGrob(p_energy_value_w_storage_noCurt + theme(legend.position = "none"))

g_sys_cost_w_storage <- ggplotGrob(p_sys_cost_w_storage + theme(legend.position = "none", axis.text.x = element_blank()))
g_sys_cost_w_storage2 <- ggplotGrob(p_sys_cost_w_storage + theme(legend.position = "none"))

g_sys_cost_w_storage_perc <- ggplotGrob(p_sys_cost_w_storage_perc + theme(legend.position = "none", axis.title.y.right = element_text(size=42), axis.text.x = element_blank()))

g_cost_emissions_avg_w_storage <- ggplotGrob(p_cost_emissions_avg_w_storage + theme(legend.position = "none"))

#### This panel is with real additional system costs of VRE
grob_storage_noCurt.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_w_storage_w_noCurt, g_capacity_value_w_storage_noCurt, g_energy_value_w_storage_noCurt, size = "last"), 
                     rbind(g_vre_storage_noCurt, g_sys_cost_w_storage, g_cost_emissions_avg_w_storage, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_storage_noCurt.plot)

#### This panel is with % additional system costs due to VRE.
grob_storage_noCurt_sys_cost_perc.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_w_storage_w_noCurt, g_capacity_value_w_storage_noCurt, g_energy_value_w_storage_noCurt, size = "last"), 
                     rbind(g_vre_storage_noCurt, g_sys_cost_w_storage_perc, g_cost_emissions_avg_w_storage, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_storage_noCurt_sys_cost_perc.plot)

#### This panel is with only 5 plots, legend is outside of plot, and CO2 emissions are omitted. 
# Grob the two legends - scenarios and black line for vre no curtailment
plot.legend.storage <- g_legend(p_capacity_value_w_storage_noCurt + theme(legend.position = "right", legend.margin = margin(l=2, unit='cm')))

# Use plot legend from vre cost panel
#plot.legend.vre.nocurt <- g_legend(p_vre_share_noCurt + theme(legend.position = "right", legend.margin = margin(l=2, unit='cm')))

# First column plot
grob_storage_noCurt.5plot.1 <-
  arrangeGrob(grobs =
                list(rbind(g_vre_share_w_storage_w_noCurt, g_capacity_value_w_storage_noCurt2, g_energy_value_w_storage_noCurt, size = "last")), ncol = 1)

# Second column plot
grob_storage_noCurt.5plot.2 <-
  arrangeGrob(grobs =
                list(rbind(g_vre_storage_noCurt, g_sys_cost_w_storage2, size = "last")), ncol = 1)

grob_plot_legend_storage_nocurt <- plot_grid(plot.legend.vre.nocurt, plot.legend.storage, nrow = 2, rel_heights = c(1,4))

grob_storage_noCurt.5plot.2.legend <- plot_grid(grob_plot_legend_storage_nocurt,
                                                              grob_storage_noCurt.5plot.2,
                                                              nrow = 2, rel_heights = c(1,2.6))

grob_storage_noCurt.5plot.3 <- plot_grid(grob_storage_noCurt.5plot.1,
                                                   grob_storage_noCurt.5plot.2.legend,
                                                   ncol = 2, rel_widths = c(1,1.02))

grob_storage_noCurt.5plot.3


#ggsave(file = paste0(output.folder.paper, "battery_storage_vre_nocurt_all_var", "_v1", ".png"), grob_storage_noCurt.plot, width=7, height=5)
#ggsave(file = paste0(output.folder.paper, "battery_storage_vre_nocurt_all_var_sys_cost_perc", "_v1", ".png"), grob_storage_noCurt_sys_cost_perc.plot, width=7, height=5)
#ggsave(file = paste0(output.folder.paper, "battery_storage_vre_nocurt_5_var", "_v1", ".png"), grob_storage_noCurt.5plot.3, width=7, height=5)


```



### Battery storage plots in a panel (cost and value expressed as per curtailed VRE)
Modify the battery plots in this code chunk. 

```{r, battery storage panel (per curtailed VRE), echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 

g_vre_share_w_storage_w_noCurt <- ggplotGrob(p_vre_share_w_storage_w_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_vre_storage <- ggplotGrob(p_vre_storage + theme(legend.position = "none", axis.text.x = element_blank()))

g_capacity_value_w_storage <- ggplotGrob(p_capacity_value_w_storage + theme(legend.position = c(0, 0.65), axis.text.x = element_blank()))

g_energy_value_w_storage <- ggplotGrob(p_energy_value_w_storage + theme(legend.position = "none", axis.text.x = element_blank()))

g_sys_cost_w_storage <- ggplotGrob(p_sys_cost_w_storage + theme(legend.position = "none"))

g_cost_emissions_avg_w_storage <- ggplotGrob(p_cost_emissions_avg_w_storage + theme(legend.position = "none"))

grob_storage.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_w_storage_w_noCurt, g_capacity_value_w_storage, g_sys_cost_w_storage, size = "last"), 
                     rbind(g_vre_storage, g_energy_value_w_storage, g_cost_emissions_avg_w_storage, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_storage.plot)

#g_storage <- rbind(g_capacity_value_w_storage, g_energy_value_w_storage, size = "first")
#g_storage$widths <- unit.pmax(g_capacity_value_w_storage$widths, g_energy_value_w_storage$widths)
#grid.newpage()
#grid.draw(g_storage)

#ggsave(file = paste0(output.folder.paper, "battery_storage_vre_curt_all_var", "_v0", ".png"), grob_storage.plot, width=7, height=5)


```

### Minimum Generation Level plots

```{r, minimum generation level, echo=FALSE, message = FALSE}

scenarios.to.include.mingen <- c("base", "coal_55mingen", "coal_ccgt_0mingen")
scenarios.labels.mingen <- c("base case - coal 70% min gen level", "coal 55% min gen level", "coal CCGT 0% min gen level")
linetype_mingen <- c(rep("solid", 3)) #c("solid", "dashed", "dashed")

scenarios.to.include.mingen <- c("base", "coal_55mingen", "coal_55mingen_wind30LC", "coal_55mingen_solar30LC", "coal_55mingen_wind30LC_solar30LC")
scenarios.labels.mingen <- c("base case - coal 70% min gen level", "coal 55% min gen level", "coal 55% min gen + low cost solar", "coal 55% min gen + low cost wind", "coal 55% min gen + low cost wind & solar")
linetype_mingen <- c(rep("solid", 7)) #c("solid", rep("dashed", 3), "solid", "solid")


## Share of VRE
p_vre_share_mingen <- plot.facet.allLines.max(results.processed, "vre_share_after_curt", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen,  "VRE share of total electricity generation", y_limits_vre_share, "", "", INR_USD/1000)
# Add vre share without curtailment as a black line
data.plot.to.add <- results.processed[scenario!="S0W0" & scenario_main == "base", .(scenario_main, scenario, scenario_build, vre_share_nocurt)]
#setnames(data.plot, c("V4"), c(eval(main_variable)))
data.plot.to.add$scenario <- reorder.factor(data.plot.to.add$scenario, new.order=positions)

p_vre_share_mingen_w_noCurt <- p_vre_share_mingen + geom_line(data = data.plot.to.add, aes(scenario, vre_share_nocurt, group = scenario_main), color = "black", size=0.5) +
facet_wrap(~scenario_build, scales = "free_x") +
scale_y_continuous(limits = y_limits_vre_share, labels = scales::percent_format(accuracy = 2),
                                      sec.axis = sec_axis(~.*1, name = "")) +
  theme(axis.text.y.right = element_blank())
p_vre_share_mingen_w_noCurt

## Cost of VRE and storage
p_vre_mingen <- plot.facet.allLines.min(results.processed, "cost_vre_battery_pMWh", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen,  "Average Cost of VRE", y_limits_vre_cost, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_vre_mingen

## Cost of VRE uncurtailed and storage
p_vre_mingen_noCurt <- plot.facet.allLines.min(results.processed, "cost_vre_battery_nocurt_pMWh", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen, "Average Cost of Potential VRE", y_limits_vre_cost, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_vre_mingen_noCurt

## Capacity value of VRE
p_capacity_value_mingen <- plot.facet.allLines.max(results.processed, "capacity_value_pMWh", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen, "Average Capacity Value of VRE", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_capacity_value_mingen

## Capacity value of VRE uncurtailed
p_capacity_value_mingen_noCurt <- plot.facet.allLines.max(results.processed, "capacity_value_nocurt_pMWh", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen, "Average Capacity Value of Potential VRE", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_capacity_value_mingen_noCurt

## Energy value of VRE
p_energy_value_mingen <- plot.facet.allLines.max(results.processed, "energy_value_pMWh", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen, "Average Energy Value of VRE", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_energy_value_mingen

## Energy value of VRE uncurtailed
p_energy_value_mingen_noCurt <- plot.facet.allLines.max(results.processed, "energy_value_nocurt_pMWh", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen, "Average Energy Value of Potential VRE", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_energy_value_mingen_noCurt


## System additional cost of VRE
p_sys_cost_mingen <- plot.facet.allLines.min(results.processed, "system_cost_add_pMWh_load", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen, "Average Additional Cost of VRE", y_limits_sys_cost, "USD/MWh of Load", "INR/kWh of Load\n", INR_USD/1000)
p_sys_cost_mingen

## System additional cost of VRE in percentage
p_sys_cost_mingen_perc <- plot.facet.allLines.min(results.processed, "system_cost_add_perc", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen, "Additional System Cost of VRE", y_limits_sys_cost_perc, "", "", INR_USD/1000)
p_sys_cost_mingen_perc <- p_sys_cost_mingen_perc + scale_y_continuous(limits = y_limits_sys_cost_perc, labels = scales::percent_format(accuracy = 2), sec.axis = sec_axis(~.*1, name = "")) +
  theme(axis.text.y.right = element_blank())
p_sys_cost_mingen_perc

## Cost of CO2 emissions mitigation
p_cost_emissions_avg_mingen <- plot.facet.allLines.min(results.processed, "cost_emissions_reduction_pTonneCO2_avg", scenarios.to.include.mingen, scenarios.labels.mingen, positions, colors_RD8, linetype_mingen, expression(Cost~of~CO[2]~Emissions~Mitigation), y_limits_cost_emissions, expression(USD/tonne~CO[2]), expression(INR/kg~CO[2]), INR_USD/1000)
p_cost_emissions_avg_mingen

```

### Minimum generation level plots in a panel (cost and value expressed as per uncurtailed VRE)
Modify the min gen plots in this code chunk

```{r, minimum generation level panel (per uncurtailied VRE), echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 

g_vre_share_mingen_w_noCurt <- ggplotGrob(p_vre_share_mingen_w_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_vre_mingen_noCurt <- ggplotGrob(p_vre_mingen_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))
g_vre_mingen_noCurt2 <- ggplotGrob(p_vre_mingen_noCurt + theme(legend.position = "none"))

g_capacity_value_mingen_noCurt <- ggplotGrob(p_capacity_value_mingen_noCurt + theme(legend.position = c(0, 0.65), axis.text.x = element_blank()))
g_capacity_value_mingen_noCurt2 <- ggplotGrob(p_capacity_value_mingen_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_energy_value_mingen_noCurt <- ggplotGrob(p_energy_value_mingen_noCurt + theme(legend.position = "none"))

g_sys_cost_mingen <- ggplotGrob(p_sys_cost_mingen + theme(legend.position = "none", axis.text.x = element_blank()))
g_sys_cost_mingen2 <- ggplotGrob(p_sys_cost_mingen + theme(legend.position = "none"))

g_sys_cost_mingen_perc <- ggplotGrob(p_sys_cost_mingen_perc + theme(legend.position = "none", axis.title.y.right = element_text(size=42), axis.text.x = element_blank()))

g_cost_emissions_avg_mingen <- ggplotGrob(p_cost_emissions_avg_mingen + theme(legend.position = "none"))

#### This panel is with real additional system costs of VRE
grob_mingen_noCurt.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_mingen_w_noCurt, g_capacity_value_mingen_noCurt, g_energy_value_mingen_noCurt, size = "last"), 
                     rbind(g_vre_mingen_noCurt, g_sys_cost_mingen, g_cost_emissions_avg_mingen, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_mingen_noCurt.plot)

#### This panel is with % additional system costs due to VRE.
grob_mingen_noCurt_sys_cost_perc.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_mingen_w_noCurt, g_capacity_value_mingen_noCurt, g_energy_value_mingen_noCurt, size = "last"), 
                     rbind(g_vre_mingen_noCurt, g_sys_cost_mingen_perc, g_cost_emissions_avg_mingen, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_mingen_noCurt_sys_cost_perc.plot)

#### This panel is with only 5 plots, legend is outside of plot, and CO2 emissions are omitted. 
# Grob the two legends - scenarios and black line for vre no curtailment
plot.legend.mingen <- g_legend(p_capacity_value_mingen_noCurt + theme(legend.position = "right", legend.margin = margin(l=2, unit='cm')))

# Use plot legend from vre cost panel
# plot.legend.vre.nocurt <- g_legend(p_vre_share_noCurt + theme(legend.position = "right", legend.margin = margin(l=2, unit='cm')))

# First column plot
grob_mingen_noCurt.5plot.1 <-
  arrangeGrob(grobs =
                list(rbind(g_vre_share_mingen_w_noCurt, g_capacity_value_mingen_noCurt2, g_energy_value_mingen_noCurt, size = "last")), ncol = 1)

# Second column plot
grob_mingen_noCurt.5plot.2 <-
  arrangeGrob(grobs =
                list(rbind(g_vre_mingen_noCurt, g_sys_cost_mingen2, size = "last")), ncol = 1)

grob_plot_legend_mingen_nocurt <- plot_grid(plot.legend.vre.nocurt, plot.legend.mingen, nrow = 2, rel_heights = c(1,4))

grob_mingen_noCurt.5plot.2.legend <- plot_grid(grob_plot_legend_mingen_nocurt,
                                                              grob_mingen_noCurt.5plot.2,
                                                              nrow = 2, rel_heights = c(1,2.6))

grob_mingen_noCurt.5plot.3 <- plot_grid(grob_mingen_noCurt.5plot.1,
                                                   grob_mingen_noCurt.5plot.2.legend,
                                                   ncol = 2, rel_widths = c(1,1.02))

grob_mingen_noCurt.5plot.3

# ggsave(file = paste0(output.folder.paper, "min_gen_levels_vre_costs_nocurt_all_var", "_v1", ".png"), grob_mingen_noCurt.plot, width=7, height=5)
# ggsave(file = paste0(output.folder.paper, "min_gen_levels_vre_costs_nocurt_all_var_sys_cost_perc", "_v1", ".png"), grob_mingen_noCurt_sys_cost_perc.plot, width=7, height=5)
# ggsave(file = paste0(output.folder.paper, "min_gen_levels_vre_noCurt_5_var_sys_cost_perc", "_v1", ".png"), grob_mingen_noCurt.5plot.3, width=7, height=5)
# ggsave(file = paste0(output.folder.paper, "min_gen_levels_vre_costs_noCurt_5_var", "_v1", ".png"), grob_mingen_noCurt.5plot.3, width=7, height=5)
```

### Minimum generation level plots in a panel (cost and value expressed as per curtailed VRE)
Modify the min gen plots in this code chunk

```{r, minimum generation level panel (per curtailied VRE), echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 

g_vre_share_mingen_w_noCurt <- ggplotGrob(p_vre_share_mingen_w_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_vre_mingen <- ggplotGrob(p_vre_mingen + theme(legend.position = "none", axis.text.x = element_blank()))

g_capacity_value_mingen <- ggplotGrob(p_capacity_value_mingen + theme(legend.position = c(0, 0.65), axis.text.x = element_blank()))

g_energy_value_mingen <- ggplotGrob(p_energy_value_mingen + theme(legend.position = "none", axis.text.x = element_blank()))

g_sys_cost_mingen <- ggplotGrob(p_sys_cost_mingen + theme(legend.position = "none"))

g_cost_emissions_avg_mingen <- ggplotGrob(p_cost_emissions_avg_mingen + theme(legend.position = "none"))

grob_mingen.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_mingen_w_noCurt, g_capacity_value_mingen, g_sys_cost_mingen, size = "last"), 
                     rbind(g_vre_mingen, g_energy_value_mingen, g_cost_emissions_avg_mingen, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_mingen.plot)

#ggsave(file = paste0(output.folder.paper, "min_gen_levels_vre_curt_all_var", "_v0", ".png"), grob_mingen.plot, width=7, height=5)

```


### Load modified plots

```{r, load modified, echo=FALSE, message = FALSE}

# scenarios.to.include.loadMod <- c("base", "load_modD0M0_energyOnly", "load_modD25M25_energyOnly", "load_modD50M0_energyOnly")
# scenarios.labels.loadMod <- c("base case - energy + peak load forecast", "energy forecast", "energy forecast-India 50%-Delhi & Mumbai 25%", "energy forecast-India 50%-Delhi 50%")
# linetype_loadMod <- c("solid", "dashed", rep("dotdash", 2))

scenarios.to.include.loadMod <- c("base", "load_modD25M25_energyOnly", "load_modD50M0_energyOnly")
scenarios.labels.loadMod <- c("base case forecast-India 100%", "forecast-India 50%-Delhi & Mumbai 25%", "forecast-India 50%-Delhi 50%")
linetype_loadMod <- c(rep("solid", 5)) #c("solid", "dashed", "dashed")

## Share of VRE
p_vre_share_loadMod <- plot.facet.allLines.max(results.processed, "vre_share_after_curt", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod,  "VRE share of total electricity generation", y_limits_vre_share, "", "", INR_USD/1000)
# Add vre share without curtailment as a black line
data.plot.to.add <- results.processed[scenario!="S0W0" & scenario_main == "base", .(scenario_main, scenario, scenario_build, vre_share_nocurt)]
#setnames(data.plot, c("V4"), c(eval(main_variable)))
data.plot.to.add$scenario <- reorder.factor(data.plot.to.add$scenario, new.order=positions)

p_vre_share_loadMod_w_noCurt <- p_vre_share_loadMod + geom_line(data = data.plot.to.add, aes(scenario, vre_share_nocurt, group = scenario_main), color = "black", size=0.5) +
facet_wrap(~scenario_build, scales = "free_x") +
scale_y_continuous(limits = y_limits_vre_share, labels = scales::percent_format(accuracy = 2),
                                      sec.axis = sec_axis(~.*1, name = "")) +
  theme(axis.text.y.right = element_blank())
p_vre_share_loadMod_w_noCurt

## Cost of VRE and storage
p_vre_loadMod <- plot.facet.allLines.min(results.processed, "cost_vre_battery_pMWh", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod,  "Average Cost of VRE", y_limits_vre_cost, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_vre_loadMod

## Cost of VRE uncurtailed and storage
p_vre_loadMod_noCurt <- plot.facet.allLines.min(results.processed, "cost_vre_battery_nocurt_pMWh", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, "Average Cost of Potential VRE", y_limits_vre_cost, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_vre_loadMod_noCurt

## Capacity value of VRE
p_capacity_value_loadMod <- plot.facet.allLines.max(results.processed, "capacity_value_pMWh", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, "Average Capacity Value of VRE", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_capacity_value_loadMod

## Capacity value of VRE uncurtailed
p_capacity_value_loadMod_noCurt <- plot.facet.allLines.max(results.processed, "capacity_value_nocurt_pMWh", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, "Average Capacity Value of Potential VRE", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_capacity_value_loadMod_noCurt

## Energy value of VRE
p_energy_value_loadMod <- plot.facet.allLines.max(results.processed, "energy_value_pMWh", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, "Average Energy Value of VRE", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_energy_value_loadMod

## Energy value of VRE uncurtailed
p_energy_value_loadMod_noCurt <- plot.facet.allLines.max(results.processed, "energy_value_nocurt_pMWh", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, "Average Energy Value of Potential VRE", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE\n", INR_USD/1000)
p_energy_value_loadMod_noCurt

## System additional cost of VRE
p_sys_cost_loadMod <- plot.facet.allLines.min(results.processed, "system_cost_add_pMWh_load", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, "Average Additional Cost of VRE", y_limits_sys_cost, "USD/MWh of Load", "INR/kWh of Load\n", INR_USD/1000)
p_sys_cost_loadMod

## System additional cost of VRE in percentage
p_sys_cost_loadMod_perc <- plot.facet.allLines.min(results.processed, "system_cost_add_perc", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, "Additional System Cost of VRE", y_limits_sys_cost_perc, "", "", INR_USD/1000)
p_sys_cost_loadMod_perc <- p_sys_cost_loadMod_perc + scale_y_continuous(limits = y_limits_sys_cost_perc, labels = scales::percent_format(accuracy = 2), sec.axis = sec_axis(~.*1, name = "")) +
  theme(axis.text.y.right = element_blank())
p_sys_cost_loadMod_perc

## Cost of CO2 emissions mitigation
p_cost_emissions_avg_loadMod <- plot.facet.allLines.min(results.processed, "cost_emissions_reduction_pTonneCO2_avg", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, expression(Cost~of~CO[2]~Emissions~Mitigation), y_limits_cost_emissions, expression(USD/tonne~CO[2]), expression(INR/kg~CO[2]), INR_USD/1000)
p_cost_emissions_avg_loadMod

```


### Trial plot function with minimum points
Trial
```{r, plot with min, echo=FALSE, message=FALSE}


# Plot function for facet lines plot by VRE target + points for minimum values
plot.facet.allLines.min <- function(results.input, main_variable, scenarios.to.include, scenarios.labels, positions, plot.colors, plot.linetype, plot_title, y_limits, y_label, y_label_sec, y_sec_multiplier){
  
  
  # results.input = copy(results.processed)
  # main_variable = "cost_emissions_reduction_pTonneCO2_avg"
  # scenarios.to.include = scenarios.to.include.loadMod
  # scenarios.labels = scenarios.labels.loadMod
  # plot.colors = colors_RD8
  # plot.linetype = linetype_loadMod
  # plot_title = expression(Cost~of~CO[2]~Emissions~Mitigation)
  # y_limits = y_limits_cost_emissions
  # y_label = expression(USD/tonne~CO[2])
  # y_label_sec = expression(INR/kg~CO[2])
  # y_sec_multiplier = INR_USD/1000
  
  # Process data to plot
  data.plot <- results.input[scenario!="S0W0" & scenario_main %in% scenarios.to.include, .(scenario_main, scenario, scenario_build, get(main_variable))]
  setnames(data.plot, c("V4"), c(eval(main_variable)))
  data.plot$scenario <- reorder.factor(data.plot$scenario, new.order=positions)
  
  data.plot.min <- data.plot[, .SD[which.min(get(main_variable))], by = c("scenario_main", "scenario_build")]

  q <- ggplot(data.plot, aes(scenario, get(main_variable), group = scenario_main, color = scenario_main, linetype = scenario_main)) +
    geom_hline(color = "grey", yintercept = 0) +
    geom_line(size=0.5) +
    geom_point(data = data.plot.min, mapping = aes(x = scenario, y = get(main_variable), group = scenario_main, color = scenario_main)) +
    #theme_bw() +
    facet_wrap(~scenario_build, scales = "free_x") +
    labs(y = y_label, x = NULL) +
    scale_color_manual(labels = scenarios.labels, values = plot.colors) + 
    scale_linetype_manual(labels = scenarios.labels, values = plot.linetype) +
    scale_x_discrete(breaks=positions, labels=share.labels) +
    ggtitle(plot_title) +
    theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.position="bottom", legend.title = element_blank(), 
          legend.key = element_rect(size=5, fill = "white"), legend.key.size = unit(0.5, 'lines'), legend.key.width = unit(1, 'lines'), 
          plot.title = element_text(face="plain"), 
          strip.background = element_rect(colour="black")) +
    scale_y_continuous(limits = y_limits, sec.axis = sec_axis(~.*y_sec_multiplier, name = y_label_sec)) +
    background_grid()
  
  return(q)
}


## Cost of CO2 emissions mitigation
p_cost_emissions_avg_loadMod_w_min <- plot.facet.allLines.min(results.processed, "cost_emissions_reduction_pTonneCO2_avg", scenarios.to.include.loadMod, scenarios.labels.loadMod, positions, colors_RD8, linetype_loadMod, expression(Cost~of~CO[2]~Emissions~Mitigation), y_limits_cost_emissions, expression(USD/tonne~CO[2]), expression(INR/kg~CO[2]), INR_USD/1000)
p_cost_emissions_avg_loadMod_w_min

```


### Modified load plots in a panel (cost and value expressed as per uncurtailed VRE)
Modify the load modification plots in this code chunk

```{r, load modified panel (per uncurtailed VRE), echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 

g_vre_share_loadMod_w_noCurt <- ggplotGrob(p_vre_share_loadMod_w_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_vre_loadMod_noCurt <- ggplotGrob(p_vre_loadMod_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))
g_vre_loadMod_noCurt2 <- ggplotGrob(p_vre_loadMod_noCurt + theme(legend.position = "none"))

g_capacity_value_loadMod_noCurt <- ggplotGrob(p_capacity_value_loadMod_noCurt + theme(legend.position = c(0, 0.65), axis.text.x = element_blank()))
g_capacity_value_loadMod_noCurt2 <- ggplotGrob(p_capacity_value_loadMod_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_energy_value_loadMod_noCurt <- ggplotGrob(p_energy_value_loadMod_noCurt + theme(legend.position = "none"))

g_sys_cost_loadMod <- ggplotGrob(p_sys_cost_loadMod + theme(legend.position = "none", axis.text.x = element_blank()))
g_sys_cost_loadMod2 <- ggplotGrob(p_sys_cost_loadMod + theme(legend.position = "none"))

g_sys_cost_loadMod_perc <- ggplotGrob(p_sys_cost_loadMod_perc + theme(legend.position = "none", axis.title.y.right = element_text(size=42), axis.text.x = element_blank()))

g_cost_emissions_avg_loadMod <- ggplotGrob(p_cost_emissions_avg_loadMod + theme(legend.position = "none"))

#### This panel is with real additional system costs of VRE
grob_loadMod_noCurt.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_loadMod_w_noCurt, g_capacity_value_loadMod_noCurt, g_energy_value_loadMod_noCurt, size = "last"), 
                     rbind(g_vre_loadMod_noCurt, g_sys_cost_loadMod, g_cost_emissions_avg_loadMod, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_loadMod_noCurt.plot)


#### This panel is with % additional system costs due to VRE.
grob_loadMod_noCurt_sys_cost_perc.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_loadMod_w_noCurt, g_capacity_value_loadMod_noCurt, g_energy_value_loadMod_noCurt, size = "last"), 
                     rbind(g_vre_loadMod_noCurt, g_sys_cost_loadMod_perc, g_cost_emissions_avg_loadMod, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_loadMod_noCurt_sys_cost_perc.plot)

#### This panel is with only 5 plots, legend is outside of plot, and CO2 emissions are omitted. 
# Grob the two legends - scenarios and black line for vre no curtailment
plot.legend.loadMod <- g_legend(p_capacity_value_loadMod_noCurt + theme(legend.position = "right", legend.margin = margin(l=2, unit='cm')))

# Use plot legend from vre cost panel
# plot.legend.vre.nocurt <- g_legend(p_vre_share_noCurt + theme(legend.position = "right", legend.margin = margin(l=2, unit='cm')))

# First column plot
grob_loadMod_noCurt.5plot.1 <-
  arrangeGrob(grobs =
                list(rbind(g_vre_share_loadMod_w_noCurt, g_capacity_value_loadMod_noCurt2, g_energy_value_loadMod_noCurt, size = "last")), ncol = 1)

# Second column plot
grob_loadMod_noCurt.5plot.2 <-
  arrangeGrob(grobs =
                list(rbind(g_vre_loadMod_noCurt, g_sys_cost_loadMod2, size = "last")), ncol = 1)

grob_plot_legend_loadMod_nocurt <- plot_grid(plot.legend.vre.nocurt, plot.legend.loadMod, nrow = 2, rel_heights = c(1,4))

grob_loadMod_noCurt.5plot.2.legend <- plot_grid(grob_plot_legend_loadMod_nocurt,
                                                              grob_loadMod_noCurt.5plot.2,
                                                              nrow = 2, rel_heights = c(1,2.6))

grob_loadMod_noCurt.5plot.3 <- plot_grid(grob_loadMod_noCurt.5plot.1,
                                                   grob_loadMod_noCurt.5plot.2.legend,
                                                   ncol = 2, rel_widths = c(1,1.02))

grob_loadMod_noCurt.5plot.3

# ggsave(file = paste0(output.folder.paper, "modified_loads_vre_nocurt_all_var", "_v1", ".png"), grob_loadMod_noCurt.plot, width=7, height=5)
# ggsave(file = paste0(output.folder.paper, "modified_loads_vre_nocurt_all_var_sys_cost_perc", "_v1", ".png"), grob_loadMod_noCurt_sys_cost_perc.plot, width=7, height=5)
# ggsave(file = paste0(output.folder.paper, "modified_loads_vre_noCurt_5_var", "_v1", ".png"), grob_loadMod_noCurt.5plot.3, width=7, height=5)

```

### Modified load plots in a panel (cost and value expressed as per curtailed VRE)
Modify the load modification plots in this code chunk

```{r, load modified panel (per curtailed VRE), echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 

g_vre_share_loadMod_w_noCurt <- ggplotGrob(p_vre_share_loadMod_w_noCurt + theme(legend.position = "none", axis.text.x = element_blank()))

g_vre_loadMod <- ggplotGrob(p_vre_loadMod + theme(legend.position = "none", axis.text.x = element_blank()))

g_capacity_value_loadMod <- ggplotGrob(p_capacity_value_loadMod + theme(legend.position = c(0, 0.65), axis.text.x = element_blank()))

g_energy_value_loadMod <- ggplotGrob(p_energy_value_loadMod + theme(legend.position = "none", axis.text.x = element_blank()))

g_sys_cost_loadMod <- ggplotGrob(p_sys_cost_loadMod + theme(legend.position = "none"))

g_cost_emissions_avg_loadMod <- ggplotGrob(p_cost_emissions_avg_loadMod + theme(legend.position = "none"))

grob_loadMod.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_vre_share_loadMod_w_noCurt, g_capacity_value_loadMod, g_sys_cost_loadMod, size = "last"), 
                     rbind(g_vre_loadMod, g_energy_value_loadMod, g_cost_emissions_avg_loadMod, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_loadMod.plot)

#ggsave(file = paste0(output.folder.paper, "modified_loads_vre_curt_all_var", "_v0", ".png"), grob_loadMod.plot, width=7, height=5)

```

### Additional System Costs due to VRE (and Storage) Panel

```{r, additional system costs panel, echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 

g_sys_cost <- ggplotGrob(p_sys_cost + ggtitle("Wind, solar, and coal costs") + 
                           theme(legend.position = c(0, 1), legend.justification = c(0, 1), axis.text.x = element_blank()))

g_sys_cost_mingen <- ggplotGrob(p_sys_cost_mingen + ggtitle("Conventional generator minimum generation levels") + 
                                  theme(legend.position = c(0, 1), legend.justification = c(0, 1), axis.text.x = element_blank()))

g_sys_cost_w_storage <- ggplotGrob(p_sys_cost_w_storage + ggtitle("Battery storage") + 
                                     theme(legend.position = c(0, 1), legend.justification = c(0, 1)))

g_sys_cost_loadMod <- ggplotGrob(p_sys_cost_loadMod + ggtitle("Future demand profiles") + 
                                   theme(legend.position = c(0, 1), legend.justification = c(0, 1)))

grob_sysCost.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_sys_cost, g_sys_cost_w_storage, size = "last"), 
                     rbind(g_sys_cost_mingen, g_sys_cost_loadMod, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_sysCost.plot)

# ggsave(file = paste0(output.folder.paper, "add_sys_costs_all_scenarios", "_v1", ".png"), grob_sysCost.plot, width=7, height=5)

```

### Average Emissions Mitigation Costs due to VRE (and Storage) Panel

```{r, average emissions mitigation costs panel, echo=FALSE, message = FALSE}

## Using the gtable way of plotting panel data. This aligns the plots to the x and y axis when the axis labels and text vary in width or height. 
# See: https://gist.github.com/tomhopper/faa24797bb44addeba79

p_cost_emissions_avg1 <- p_cost_emissions_avg + ggtitle("Wind, solar, and coal costs") + 
                                     theme(legend.position = c(0, 1), legend.justification = c(0, 1), 
                                           axis.text.x = element_blank())

g_cost_emissions_avg <- ggplotGrob(p_cost_emissions_avg1) 

p_cost_emissions_avg_mingen1 <- p_cost_emissions_avg_mingen + ggtitle("Conventional generator minimum generation levels") +
                                            theme(legend.position = c(0, 1), legend.justification = c(0, 1), 
                                                  axis.text.x = element_blank())

g_cost_emissions_avg_mingen <- ggplotGrob(p_cost_emissions_avg_mingen1)

p_cost_emissions_avg_w_storage1 <- p_cost_emissions_avg_w_storage + ggtitle("Battery storage") + 
                                               theme(legend.position = c(0, 1), legend.justification = c(0, 1))

g_cost_emissions_avg_w_storage <- ggplotGrob(p_cost_emissions_avg_w_storage1)

p_cost_emissions_avg_loadMod1 <- p_cost_emissions_avg_loadMod + ggtitle("Future demand profiles") + 
                                             theme(legend.position = c(0, 1), legend.justification = c(0, 1))

g_cost_emissions_avg_loadMod <- ggplotGrob(p_cost_emissions_avg_loadMod1)

grob_emissionsCost.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_cost_emissions_avg, g_cost_emissions_avg_w_storage, size = "last"), 
                     rbind(g_cost_emissions_avg_mingen, g_cost_emissions_avg_loadMod, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_emissionsCost.plot)

#ggsave(file = paste0(output.folder.paper, "emissions_costs_all_scenarios", "_v0", ".png"), grob_emissionsCost.plot, width=7, height=5)

# Adding VRE split chart as x axis
p_vre_split1 <- p_vre_split + theme(legend.position = "none", axis.text.x = element_blank(), strip.background = element_blank(), strip.text.x = element_blank(), axis.text.y.right = element_blank(), axis.title.y.right = element_text(size = 2), axis.ticks.x.bottom = element_blank(), axis.ticks.y = element_blank(), axis.line = element_blank()) +
  xlab("VRE mixes (% share of wind and solar)") + ylab("")

# Grab the vre split legend
plot.legend.vre.split <- g_legend(p_vre_split)

g_vre_split1 <- ggplotGrob(p_vre_split1)

p_vre_split2 <- p_vre_split + labs(y = "") + theme(legend.position = "none", axis.text.x = element_blank(), axis.title.x = element_blank(),strip.background = element_blank(),
  strip.text.x = element_blank(), axis.text.y.left = element_blank(), axis.title.y.left = element_text(size = 34),  axis.text.y.right = element_blank(), axis.title.y.right = element_text(size = 26), axis.ticks.x.bottom = element_blank(), axis.ticks.y.left = element_blank(), axis.ticks.y.right = element_blank())

g_vre_split2 <- ggplotGrob(p_vre_split2)

# Remove x labels from plots
p_cost_emissions_avg_w_storage_no_xlabel <- p_cost_emissions_avg_w_storage + ggtitle("Battery storage") + theme(legend.position = c(0, 1), legend.justification = c(0, 1), axis.text.x = element_blank())

p_cost_emissions_avg_loadMod_no_xlabel <- p_cost_emissions_avg_loadMod + ggtitle("Future demand profiles") + theme(legend.position = c(0, 1), legend.justification = c(0, 1), axis.text.x = element_blank())

## OLd way, but doesn't align the vre split plot with the rest of the plots 
# g_cost_emissions_avg_w_storage_no_xlabel <- ggplotGrob(p_cost_emissions_avg_w_storage_no_xlabel)
# g_cost_emissions_avg_loadMod_no_xlabel <- ggplotGrob(p_cost_emissions_avg_loadMod_no_xlabel)
# 
# grob_emissionsCost.plot2 <- 
#   arrangeGrob(grobs = 
#                 list(rbind(g_cost_emissions_avg, g_cost_emissions_avg_w_storage_no_xlabel, size = "last"), 
#                      rbind(g_cost_emissions_avg_mingen, g_cost_emissions_avg_loadMod_no_xlabel, size = "last")), ncol = 2)
# 
# grob_emissionsCost.plot3 <- arrangeGrob(grob_emissionsCost.plot2, arrangeGrob(cbind(g_vre_split1, g_vre_split2, size = "last")), heights = c(10, 2))
# 
# grid.newpage()
# grid.draw(grob_emissionsCost.plot3)


## New way, this aligns the vre split with the rest of the plots
gA=ggplot_gtable(ggplot_build(p_cost_emissions_avg1))
gB=ggplot_gtable(ggplot_build(p_cost_emissions_avg_mingen1))
gC=ggplot_gtable(ggplot_build(p_cost_emissions_avg_w_storage_no_xlabel))
gD=ggplot_gtable(ggplot_build(p_cost_emissions_avg_loadMod_no_xlabel))
gE=ggplot_gtable(ggplot_build(p_vre_split1))
gF=ggplot_gtable(ggplot_build(p_vre_split1))

maxWidth = grid::unit.pmax(gA$widths, gB$widths, gC$widths, gD$widths, gE$widths, gF$widths)
gA$widths <- as.list(maxWidth)
gB$widths <- as.list(maxWidth)
gC$widths <- as.list(maxWidth)
gD$widths <- as.list(maxWidth)
gE$widths <- as.list(maxWidth)
gF$widths <- as.list(maxWidth)

grob_emissionsCost.plot3 <- arrangeGrob(gA,gB,gC,gD,gE,gF,nrow=3,heights=c(.5, .5, .2))

grid.newpage()
grid.draw(grob_emissionsCost.plot3)


grob_emissionsCost.plot4 <- arrangeGrob(arrangeGrob(gA,gB,gC,gD,gE,gF,nrow=3,heights=c(.5, .5, .25)), plot.legend.vre.split, nrow = 2, heights=c(10,0.5))

grid.newpage()
grid.draw(grob_emissionsCost.plot4)

#ggsave(file = paste0(output.folder.paper, "emissions_costs_all_scenarios", "_v1", ".png"), grob_emissionsCost.plot, width=7, height=5)
# ggsave(file = paste0(output.folder.paper, "emissions_costs_all_scenarios_vre_split", "_v1", ".png"), grob_emissionsCost.plot4, width=7, height=5)



```


### Changing VRE value with higher hub heights and solar PV tracking

```{r, VRE value new technology, echo=FALSE, fig.height=4, fig.width=7}
## 
scenarios.to.include.vre <- c("base", "wind120HH_solar1A")
scenarios.labels.vre <- c("80m hub height wind and fixed tilt solar PV", "120m hub height wind and 1A tracking solar PV ")
linetype_vre2 <- c("solid", "dashed", "longdash", "dotted", "dotdash")


## Capacity value of VRE
p_capacity_value_newTech <- plot.allLines.byVREsplit(results.processed, "capacity_value_pMWh", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD3, linetype_vre2, "Average Capacity Value of VRE", y_limits_capacity_value, "USD/MWh of VRE", "INR/kWh of VRE", INR_USD/1000)
p_capacity_value_newTech

## Energy value of VRE
p_energy_value_newTech <- plot.allLines.byVREsplit(results.processed, "energy_value_pMWh", scenarios.to.include.vre, scenarios.labels.vre, positions, colors_RD3, linetype_vre2, "Average Energy Value of VRE", y_limits_energy_value, "USD/MWh of VRE", "INR/kWh of VRE", INR_USD/1000)
p_energy_value_newTech

## Capacity and energy value in a panel

g_capacity_value_newTech <- ggplotGrob(p_capacity_value_newTech + theme(legend.position = c(0, 0.65), axis.text.y.right = element_blank(), axis.title.y.right = element_blank())) 

g_energy_value_newTech <- ggplotGrob(p_energy_value_newTech + theme(legend.position = "none", axis.title.y.left = element_blank()))

grob_vre_value_newTech.plot <- 
  arrangeGrob(grobs = 
                list(rbind(g_capacity_value_newTech, size = "last"), 
                     rbind(g_energy_value_newTech, size = "last")), ncol = 2)

grid.newpage()
grid.draw(grob_vre_value_newTech.plot)

```


```{r, test plotly, echo=FALSE, eval = FALSE}

## All lines
p <- plot.sys_cost_add_pMWh_load.allLines(results.processed, scenarios.to.include.battery, positions)

ggplotly(p)

```


### Capacity buildout for base case

```{r, capacity buildout, echo=FALSE}

scenario.to.include <- "base"

## Capacity buildout stack #########
capacity.buildout <- results.processed[scenario_main == scenario.to.include, .(scenario, scenario_build, new_capacity_coal_MW, new_capacity_gas_ccgt_MW, new_capacity_gas_ct_MW, capacity_solarPV_MW, capacity_wind_MW)]
setnames(capacity.buildout, c("new_capacity_coal_MW", "new_capacity_gas_ccgt_MW", "new_capacity_gas_ct_MW", "capacity_solarPV_MW", "capacity_wind_MW"), c("New Coal", "New Gas CCGT", "New Gas CT", "Solar PV", "Wind"))
capacity.buildout.melt <- melt(capacity.buildout, id.vars = c("scenario", "scenario_build"))
setnames(capacity.buildout.melt, c("variable", "value"), c("technology", "capacity_MW"))
capacity.buildout.melt[, capacity_GW:= capacity_MW/10^3]

# Existing capacity
scenario_list <- capacity.buildout[, .(scenario, scenario_build)]
existing.gen.capacity.all.scenarios <- cbind(existing.gen.capacity[rep(seq(nrow(existing.gen.capacity)), 16)], scenario_list[rep(seq_len(nrow(scenario_list)), each=9),])
existing.gen.capacity.all.scenarios[, capacity_GW:= capacity_MW/10^3]

# join the new and existing buildouts
capacity.all <- rbind(capacity.buildout.melt, existing.gen.capacity.all.scenarios)
#capacity.all[, capacity_GW:= capacity_MW/10^3]
capacity.all[technology=="coal", technology:= "Existing Coal"]
capacity.all[technology=="gas_ccgt", technology:= "Existing Gas CCGT"]
capacity.all[technology=="gas_ct", technology:= "Existing Gas CT"]
capacity.all[technology=="diesel", technology:= "Existing Diesel"]
capacity.all[technology=="hydro_storage", technology:= "Existing Hydro Storage"]
capacity.all[technology=="hydro_pondage", technology:= "Existing Hydro RoR"]
capacity.all[technology=="hydro_ror", technology:= "Existing Hydro RoR"]
capacity.all[technology=="nuclear", technology:= "Existing Nuclear"]
capacity.all[technology=="other", technology:= "Existing Other"]

colors.capacity.buildout <- c("#CC79A7", "#D55E00", "#56B4E9", "#0072B2", "#000000", "#CC3333", "#FF6600", "#999999", "#FF9900", "#006699", "#CC3333", "#FF6600", "#999999")
colors.capacity.buildout <- c("#666666", "#FF6600", "#CC3333", "#FF9900", "#006699", "#999999", "#FF6600", "#CC3333", "#000000", "#0072B2", "#56B4E9", "#D55E00", "#CC79A7")

#####
# Plot the capacities - both existing and new capacities
capacity.all$technology <- reorder.factor(capacity.all$technology, new.order=positions.tech)
capacity.all$scenario <- reorder.factor(capacity.all$scenario, new.order=positions3)
capacity.all <- capacity.all[order(-technology)]
                              
p_all_capacity <- ggplot(capacity.all, aes(scenario, capacity_GW, fill = technology, order = technology)) +
  geom_bar(stat = "identity", width = width.bar) +
  labs(y = "Installed Capacity (MW)", x = NULL) +
  scale_fill_manual(values = colors.capacity.buildout) + 
  scale_x_discrete(breaks=positions3, labels=share.labels2) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.title = element_blank()) +
  background_grid()

p_all_capacity
#####

#####
# Plot the buildout - Only new capacities
capacity.buildout.melt$technology <- reorder.factor(capacity.buildout.melt$technology, new.order=positions.tech)
capacity.buildout.melt$scenario <- reorder.factor(capacity.buildout.melt$scenario, new.order=positions3)
capacity.buildout.melt <- capacity.buildout.melt[order(-technology)]
                              
p_buildout <- ggplot(capacity.buildout.melt, aes(scenario, capacity_GW, fill = technology, order = technology)) +
  geom_bar(stat = "identity", width = width.bar) +
  labs(y = "Installed Capacity (MW)", x = NULL) +
  scale_fill_manual(values = colors.capacity.buildout) + 
  scale_x_discrete(breaks=positions3, labels=share.labels2) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.title = element_blank()) +
  background_grid()

p_buildout
#####

#####
# Plot the buildout - Only new conventional capacities
capacity.buildout.melt$technology <- reorder.factor(capacity.buildout.melt$technology, new.order=positions.tech)
capacity.buildout.melt$scenario <- reorder.factor(capacity.buildout.melt$scenario, new.order=positions3)
capacity.buildout.melt <- capacity.buildout.melt[order(-technology)]
capacity.buildout.melt.conv <- capacity.buildout.melt[!technology %in% c("Wind","Solar PV")]
                              
p_buildout_conv <- ggplot(capacity.buildout.melt.conv, aes(scenario, capacity_GW, fill = technology, order = technology)) +
  geom_bar(stat = "identity", width = width.bar) +
  facet_grid(~scenario_build, scales = "free_x", space = "free_x") +
  labs(y = "Installed Capacity (MW)", x = NULL) +
  scale_fill_manual(values = colors.capacity.buildout) + 
  scale_x_discrete(breaks=positions3, labels=share.labels2) +
  theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.title = element_blank()) +
  background_grid()

p_buildout_conv

  # q <- ggplot(data.plot, aes(scenario, get(main_variable), group = scenario_main, color = scenario_main, linetype = scenario_main)) +
  #   geom_hline(color = "grey", yintercept = 0) +
  #   geom_line(size=0.5) +
  #   #theme_bw() +
  #   facet_wrap(~scenario_build, scales = "free_x") +
  #   labs(y = y_label, x = NULL) +
  #   scale_color_manual(labels = scenarios.labels, values = plot.colors) + 
  #   scale_linetype_manual(labels = scenarios.labels, values = plot.linetype) +
  #   scale_x_discrete(breaks=positions, labels=share.labels) +
  #   ggtitle(plot_title) +
  #   theme(axis.text.x = element_text(angle=90, hjust=1, vjust=1), legend.position="bottom", legend.title = element_blank(), 
  #         legend.key = element_rect(size=5, fill = "white"), legend.key.size = unit(0.5, 'lines'), legend.key.width = unit(1, 'lines'), 
  #         plot.title = element_text(face="plain"), 
  #         strip.background = element_rect(colour="black")) +
  #   scale_y_continuous(limits = y_limits, sec.axis = sec_axis(~.*y_sec_multiplier, name = y_label_sec)) +
  #   background_grid()
#####
```

### Modified load curves

```{r, modified load curves, echo=FALSE}
# Read data from modified load forecasts
load_india_2030_forecasts <- fread(paste0(input.folder, "load_forecasts/load2030_19EPSmod_all.csv"))

# Label facets
month_labels <- c("1" = "Jan", "2" = "Feb", "3" = "Mar", "4" = "Apr", 
                    "5" = "May", "6" = "Jun", "7" = "Jul", "8" = "Aug",
                    "9" = "Sep", "10" = "Oct", "11" = "Nov", "12" = "Dec")

month_labeller <- function(value){
  return(month_labels[value])
}

# Plot functions from the load modification script. 
#By month and hour (Mean)
plot_comparison_byMonth_byHour_line <- function(input_data, input_columns, scenarios.labels, yAxisLabel, plot.colors, plot.linetypes){
  data_summary_byMonth_byHour <- input_data[,lapply(.SD, mean), by = .(month(dateTime), hour(dateTime)), .SDcols = input_columns]
  data_summary_byMonth_byHour_toPlot <- melt(data_summary_byMonth_byHour, id.vars=c("month", "hour"), measure.vars=input_columns, variable.name="type", value.name="value")
  ggplot(data_summary_byMonth_byHour_toPlot, aes(x = hour, y = value/10^3, color = type, linetype = type)) + 
    geom_line(stat="identity") + 
    theme_bw() +
    expand_limits(y = 0) +
    facet_wrap(~month, ncol=4, labeller = labeller(month = month_labeller)) +
    labs(y = yAxisLabel, x = "Hour") +
    theme(legend.position="bottom", legend.title = element_blank(),
          strip.background = element_rect(color="black", fill="white")) +
    scale_color_manual(labels = scenarios.labels, values = plot.colors) +
    scale_linetype_manual(labels = scenarios.labels, values = plot.linetypes) +
    background_grid()
}

# Cumulative load distribution curves
#By month and hour (Mean)
plot_cum_load_distribution_curves <- function(input_data, input_columns, scenarios.labels, yAxisLabel, plot.colors, plot.linetypes){
  input_data_sorted <- input_data[, .SD, .SDcols = c("Timepoint")]
  for(input_column in input_columns){
    input_column_sorted <- as.data.table(input_data[, .SD, .SDcols = c(eval(input_column))])[order(-get(input_column))]
    input_data_sorted[, eval(input_column) := input_column_sorted] # sorted load from each column
  }
  data_to_plot <- melt(input_data_sorted, id.vars=c("Timepoint"), measure.vars=input_columns, variable.name="type", value.name="value")
  ggplot(data_to_plot, aes(x = Timepoint, y = value/10^3, color = type, linetype = type)) + 
    geom_line(stat="identity") + 
    theme_bw() +
    expand_limits(y = 0) +
    labs(y = yAxisLabel, x = "Hour") +
    theme(legend.position="bottom", legend.title = element_blank()) +
    scale_color_manual(labels = scenarios.labels, values = plot.colors) +
    scale_linetype_manual(labels = scenarios.labels, values = plot.linetypes) +
    background_grid()
}


#### GENERATE PLOTS
## Colors
colors_RD4 <- c("#fd8d3c", "black", "#2b8cbe", "#969696")
#colors_RD5 <- c("#2b8cbe", "#fd8d3c", "#969696")
colors_RD7 <- c("#5588bb", "#66bbbb", "#aa6644", "#99bb55","#ee9944", "#444466", "#bb5555")
linetype_RD <- c("solid", rep("dashed", 6))
linetype_RD_dotted <- c("solid", rep("dotted", 6))

#### Load forecast comparison plots
# Base case is CEA peak load and energy forecast
# Difference between base case and load_mod_D0_M0_energyPeak is that I forecasted base case separately for each state and then aggregated the data. For load_mod_D0_M0_energyPeak, I forecasted the total India demand using the India 2014 demand profile. The two curves are very similar. So I am going to plot just one. 

# Compare all the 7 load forecast scenarios
# columns.to.plot <- c("load", "load_mod_D0_M0_energyPeak", "load_mod_D0_M0_energyOnly", "load_mod_D25_M25_energyPeak", "load_mod_D25_M25_energyOnly", "load_mod_D50_M0_energyPeak", "load_mod_D50_M0_energyOnly")
# labels.series <- c("CEA peak load and energy forecast orig", "CEA peak load and energy forecast", "CEA energy only forecast", "Modified 25% Delhi 25% Mumbai peak+energy", "Modified 25% Delhi 25% Mumbai energy only", "Modified 50% Delhi load peak+energy", "Modified 50% Delhi load energy only")

# Compare the base case forecast, India + Delhi 25% + Mumbai 25% forecast, and the peakiest India + Delhi 50% forecast
columns.to.plot <- c("load", "load_mod_D25_M25_energyOnly", "load_mod_D50_M0_energyOnly")
labels.series <- c("base case forecast-India 100%", "forecast-India 50%-Delhi & Mumbai 25%", "forecast-India 50%-Delhi 50%")

# Compare the base case state-wise forecast with the India aggregate forecast
# columns.to.plot <- c("load", "load_mod_D0_M0_energyPeak")
# labels.series <- c("CEA peak load and energy forecast orig", "CEA peak load and energy forecast")

# Month-Hour 12-24 plots of load
p_load_month_hour <- plot_comparison_byMonth_byHour_line(load_india_2030_forecasts[Day <=365,], columns.to.plot, labels.series, "Hourly average load (GW)", colors_RD8, linetype_RD)

# Cumulative load distribution curves
p_cum_load_dist_curve <- plot_cum_load_distribution_curves(load_india_2030_forecasts[Day <=365,], columns.to.plot, labels.series, "Hourly load (GW)", colors_RD8, linetype_RD_dotted)

ggsave(file = paste0(output.folder.paper, "load_by_month_by_hour", "_v0", ".png"), p_load_month_hour, width=7, height=5)
ggsave(file = paste0(output.folder.paper, "load_cumul_load_dist_curves", "_v0", ".png"), p_cum_load_dist_curve, width=7, height=5)

```

## Statistics for paper

```{r, paper statistics, echo = FALSE}

## Comparison between two main scenarios. 
results.processed[scenario_main %in% c("base", "battery60"), .SD, .SDcols = c("scenario", "scenario_main", "new_capacity_coal_MW", "new_capacity_gas_ccgt_MW", "new_capacity_gas_ct_MW")]


## VRE costs for wind and solar for different targets - Average NOT Marginal. For marginal LCOE, I will need to dig into the GIS outputs. 
# Because I did not save the wind and solar generation before curtailment numbers, 
# I need to read these input RE generation files for estimating avg CFs.
results.processed[scenario_main %in% c("base", "wind30LC_solar30LC") & scenario %in% c("S50W150", "S150W50", "S0W600", "S600W0"), ]


for (sc_main in c("base", "wind30LC_solar30LC")){
  for (sc_vre_input in c("S50W150", "S150W50", "S0W600", "S600W0")){
    vre_gen_profiles_input <- fread(paste0(input.folder, "REvalue_gen_profiles/2014_RE_gen_", sc_vre_input, ".csv"))
    cf.solar <- mean(vre_gen_profiles_input[, solarPV])
    cf.wind <- mean(vre_gen_profiles_input[, wind])
    
    capacity.solar.MW <- results.processed[scenario_main ==sc_main & scenario %in% sc_vre_input, capacity_solarPV_MW]
    capacity.wind.MW <- results.processed[scenario_main ==sc_main & scenario %in% sc_vre_input, capacity_wind_MW]
    
    total.cost.solar.mil <- results.processed[scenario_main ==sc_main & scenario %in% sc_vre_input, ann_cap_cost_solar_mil]
    total.cost.wind.mil <- results.processed[scenario_main ==sc_main & scenario %in% sc_vre_input, ann_cap_cost_wind_mil]
    
    cost.perMWH.solar <- total.cost.solar.mil*10^6/(capacity.solar.MW * cf.solar * 8760)
    cost.perMWH.wind <- total.cost.wind.mil*10^6/(capacity.wind.MW * cf.wind * 8760)
    
    print(paste0("For ", sc_main, " and ", sc_vre_input, ", cost per MWh for wind is ", cost.perMWH.wind, " and for solar is ", cost.perMWH.solar))
    
  }
}

# coal_share_new_conv_cap, avoided_conv_cap_mw_perVREmw, capacity_value_nocurt_pMWh, energy_value_nocurt_pMWh, grid_emissions_factor_kg_kWh, total_emissions_co2_milTonnes, emissions_reduction,
# avoided_conv_cap_mw_perVREmw, avoided_conv_cap_mw_per_new_conv_noRE_mw, coal_share_new_conv_cap, plf_coal
# load_modD25M25_energyOnly, load_modD50M0_energyOnly, battery60, battery30, wind30LC_solar30LC_coalHC


scenarios.summary.results <- c("base", "high_cost_coal", "coal_55mingen", "coal_ccgt_0mingen", "wind30LC", "solar30LC", "wind30LC_solar30LC", "wind30LC_solar30LC_coalHC", "battery30", "battery60", "battery30B50LC", "battery60B50LC", "battery60B50LC_wind30LC", "battery60B50LC_solar30LC", "battery60B50LC_wind30LC_solar30LC", "battery60_coalHC", "battery60B50LC_coalHC", "battery60B50LC_wind30LC_coalHC", "battery60B50LC_solar30LC_coalHC", "battery60B50LC_wind30LC_solar30LC_coalHC", "coal_55mingen_wind30LC", "coal_55mingen_solar30LC", "coal_55mingen_wind30LC_solar30LC", "load_modD0M0_energyOnly", "load_modD50M0_energyOnly", "load_modD25M25_energyOnly") 

results.summary <- results.processed[scenario_main %in% scenarios.summary.results,]

# avoided conventional gen and plf results; emissions
results.summary[scenario_main == "base", .SD, .SDcols = c("scenario", "avoided_conv_cap_mw_perVREmw", "avoided_conv_cap_mw_per_new_conv_noRE_mw", "coal_share_new_conv_cap", "plf_coal", "grid_emissions_factor_kg_kWh", "total_emissions_co2_milTonnes", "emissions_reduction")]

# 
results.summary[scenario_main == "base", .SD, .SDcols = c("scenario", "avoided_conv_cap_mw_perVREmw", "avoided_conv_cap_mw_per_new_conv_noRE_mw", "coal_share_new_conv_cap", "plf_coal", "grid_emissions_factor_kg_kWh", "total_emissions_co2_milTonnes", "emissions_reduction")]

# Summary of results for a particular mix of solar and wind
results.summary[scenario == "S150W450", .SD, .SDcols = c("scenario", "scenario_main",  "grid_emissions_factor_kg_kWh", "total_emissions_co2_milTonnes", "emissions_reduction")]

#max and min
max(results.summary[scenario_main == "base", avoided_conv_cap_mw_per_new_conv_noRE_mw], na.rm = TRUE)
max(results.summary[, avoided_conv_cap_mw_perVREmw], na.rm = TRUE)

# Comparing scenarios
# VRE share after curtailment
results.summary[scenario_main == "base" | scenario_main == "wind30LC_solar30LC_coalHC", .SD, .SDcols = c("scenario", "scenario_main", "vre_share_after_curt")]

results.summary[scenario_main == "base" | scenario_main == "wind30LC_solar30LC_coalHC", .SD, .SDcols = c("scenario", "scenario_main", "capacity_value_pMWh", "energy_value_pMWh")]


```

## Paper results - functions

```{r, results functions, echo = FALSE}

# Max values by build (with filter for split)
max_values_by_build <- function(results.data, results.scenarios.main, results.scenarios.split, result.parameter, other.parameter=NULL){
  results.data[scenario_main %in% results.scenarios.main & scenario_split %in% results.scenarios.split, .SD, .SDcols = c("scenario", "scenario_main", "scenario_build", "scenario_split", result.parameter, other.parameter)][, .SD[which.max(get(result.parameter))], by=c("scenario_build", "scenario_main")]
}


# Min values by build (with filter for split)
min_values_by_build <- function(results.data, results.scenarios.main, results.scenarios.split, result.parameter, other.parameter=NULL){
  results.data[scenario_main %in% results.scenarios.main & scenario_split %in% results.scenarios.split, .SD, .SDcols = c("scenario", "scenario_main", "scenario_build", "scenario_split", result.parameter, other.parameter)][, .SD[which.min(get(result.parameter))], by=c("scenario_build", "scenario_main")]
}

# Comparison between two scenarios [Percentage is in proportion to the first scenario in the list. Difference is scenario 2 - scenario 1]
compare_scenarios_by_build <- function(results.data, results.scenarios.to.compare, result.parameter){
  #results.data[scenario_main %in% results.scenarios.to.compare,lapply(.SD,diff),by=c("scenario"),.SDcols = result.parameter]
  results.data.wide <- dcast(results.data[scenario_main %in% results.scenarios.to.compare, .SD, .SDcols = c("scenario_main", "scenario", result.parameter)], scenario ~ scenario_main, value.var = result.parameter)
  results.data.wide[, diff := get(results.scenarios.to.compare[2]) - get(results.scenarios.to.compare[1])]
  results.data.wide[, perc_diff := diff / get(results.scenarios.to.compare[1])]
  results.data.wide$scenario <- reorder.factor(results.data.wide$scenario, new.order=positions)
  results.data.wide
}


```

## Paper results - max and min cost of VRE

Max and min cost of VRE

```{r, results max min VRE cost, echo = FALSE, results = 'asis'}
scenario.main.list <- c("base", "wind30LC_solar30LC_coalHC", "battery60")
scenario.split.list <- c("0-100", "25-75", "50-50", "75-25", "100-0")

max_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("cost_vre_battery_nocurt_pMWh"))

min_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("cost_vre_battery_nocurt_pMWh"))

```

## Paper results - max and min capacity energy value

Max and min capacity and energy values

```{r, results max min capacity energy value, echo = FALSE, results = 'asis'}
scenario.main.list <- c("base", "wind30LC_solar30LC_coalHC", "coal_55mingen", "high_cost_coal", "battery30", "battery60", "battery60B50LC_coalHC", "load_modD25M25_energyOnly", "load_modD50M0_energyOnly")

scenario.split.list <- c("0-100", "25-75", "50-50", "75-25", "100-0")

max_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("capacity_value_nocurt_pMWh"))

min_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("capacity_value_nocurt_pMWh"))

max_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("energy_value_nocurt_pMWh"))

min_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("energy_value_nocurt_pMWh"))

```

## Paper results - max and min additional system costs
Max and min additional costs and costs of mitigating carbon emissions

```{r, results max min add sys costs and C mitigation, echo = FALSE, results = 'asis'}
scenario.main.list <- c("base", "wind30LC", "solar30LC", "wind30LC_solar30LC", "wind30LC_solar30LC_coalHC", "coal_55mingen", "coal_ccgt_0mingen", "high_cost_coal", "battery30", "battery60", "battery30B50LC", "battery60B50LC", "battery60B50LC_coalHC", "load_modD25M25_energyOnly", "load_modD50M0_energyOnly")

scenario.main.list <- c("base", "high_cost_coal", "coal_55mingen", "coal_ccgt_0mingen", "wind30LC", "solar30LC", "wind30LC_solar30LC", "wind30LC_solar30LC_coalHC", "battery30", "battery60", "battery30B50LC", "battery60B50LC", "battery60B50LC_wind30LC", "battery60B50LC_solar30LC", "battery60B50LC_wind30LC_solar30LC", "battery60_coalHC", "battery60B50LC_coalHC", "battery60B50LC_wind30LC_coalHC", "battery60B50LC_solar30LC_coalHC", "battery60B50LC_wind30LC_solar30LC_coalHC", "coal_55mingen_wind30LC", "coal_55mingen_solar30LC", "coal_55mingen_wind30LC_solar30LC", "load_modD0M0_energyOnly", "load_modD50M0_energyOnly", "load_modD25M25_energyOnly") 


scenario.split.list <- c("0-100", "25-75", "50-50", "75-25", "100-0")
scenario.split.list.nonzero <- c("25-75", "50-50", "75-25")

max_values_by_build(results.summary, scenario.main.list, scenario.split.list.nonzero, c("system_cost_add_pMWh_load"))

min_values_by_build(results.summary, scenario.main.list, scenario.split.list.nonzero, c("system_cost_add_pMWh_load"))

max_values_by_build(results.summary, scenario.main.list, scenario.split.list.nonzero, c("system_cost_add_perc"))

min_values_by_build(results.summary, scenario.main.list, scenario.split.list.nonzero, c("system_cost_add_perc"))

max_values_by_build(results.summary, scenario.main.list, scenario.split.list.nonzero, c("cost_emissions_reduction_pTonneCO2_avg"), c( "total_emissions_co2_milTonnes"))

min_values_by_build(results.summary, scenario.main.list, scenario.split.list.nonzero, c("cost_emissions_reduction_pTonneCO2_avg"), c( "total_emissions_co2_milTonnes"))

max_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("emissions_reduction"), c( "total_emissions_co2_milTonnes"))

min_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("emissions_reduction"), c("total_emissions_co2_milTonnes"))

# Curtailment and realized share of VRE
min_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("vre_curt"))

max_values_by_build(results.summary, scenario.main.list, scenario.split.list, c("vre_share_after_curt"))

```

## Paper results - emissions for no VRE 
Emissions for no VRE 

```{r, results total emissions no VRE, echo = FALSE, results = 'asis'}
scenario.main.list <- c("base", "coal_55mingen", "coal_ccgt_0mingen", "high_cost_coal", "load_modD25M25_energyOnly", "load_modD50M0_energyOnly")

scenario.split.list <- c("0-100", "25-75", "50-50", "75-25", "100-0")
scenario.split.list.nonzero <- c("25-75", "50-50", "75-25")
scenario.split.list.zero <- c("0-0")


# Emissions from no VRE base scenario are less than 0.5% less than the two urbanized demand profile scenarios.
max_values_by_build(results.summary, scenario.main.list, scenario.split.list.zero, c( "total_emissions_co2_milTonnes"))



```

## Paper results - comparison between two scenarios
Comparison between scenarios 

```{r, results total emissions no VRE, echo = FALSE, results = 'asis'}

#### New conventional capacity
# Adding new column here for new conventional capacity but I have added this column in the earlier code. Should delete this when I rerun the script. 
#results.summary[, new_conventional_capacity_MW := new_capacity_coal_MW + new_capacity_gas_ccgt_MW + new_capacity_gas_ct_MW]

# Use either the below function or the actual code in the function below. (Don't know wht I need to output results twice to see the table once)
scenario.comparison <- compare_scenarios_by_build(results.summary, c("base", "battery30"), "new_conventional_capacity_MW")
scenario.comparison[order(factor(scenario, levels = positions))]

scenario.comparison <- compare_scenarios_by_build(results.summary, c("base", "battery60"), "new_conventional_capacity_MW")
scenario.comparison[order(factor(scenario, levels = positions))]

scenario.comparison <- compare_scenarios_by_build(results.summary, c("base", "load_modD50M0_energyOnly"), "new_conventional_capacity_MW")
scenario.comparison[order(factor(scenario, levels = positions))]

scenario.comparison <- compare_scenarios_by_build(results.summary, c("base", "load_modD25M25_energyOnly"), "new_conventional_capacity_MW")
scenario.comparison[order(factor(scenario, levels = positions))]


# Difference between new conventional capacity required between two scenarios
# results.summary[scenario_main %in% c("base", "battery30"),lapply(.SD,diff),by=c("scenario"),.SDcols = c("new_conventional_capacity_MW")]
# 
# results.summary[scenario_main %in% c("base", "battery60"),lapply(.SD,diff),by=c("scenario"),.SDcols = c("new_conventional_capacity_MW")]
# 
# results.summary[scenario_main %in% c("base", "load_modD50M0_energyOnly"),lapply(.SD,diff),by=c("scenario"),.SDcols = c("new_conventional_capacity_MW")]
# 
# results.summary[scenario_main %in% c("base", "load_modD25M25_energyOnly"),lapply(.SD,diff),by=c("scenario"),.SDcols = c("new_conventional_capacity_MW")]

#### Energy Value
scenario.comparison <- compare_scenarios_by_build(results.summary, c("base", "high_cost_coal"), "energy_value_nocurt_pMWh")
scenario.comparison[order(factor(scenario, levels = positions))]

#### Additional system costs
scenario.comparison <- compare_scenarios_by_build(results.summary, c("base", "high_cost_coal"), "system_cost_add_pMWh_load")
scenario.comparison[order(factor(scenario, levels = positions))]

```


## Paper results - LCOE base case

```{r, results lcoe base case, echo = FALSE}


```